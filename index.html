<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Absensi Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-blue-50 to-indigo-100 font-sans">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-96 max-w-md mx-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Sistem Absensi Sekolah</h2>
                <p class="text-gray-600">Masukkan kode unik Anda</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="userCode" class="block text-sm font-medium text-gray-700 mb-2">Kode Unik</label>
                    <input type="text" id="userCode" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan kode unik">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    Masuk
                </button>
            </form>
            <div class="mt-6 text-center">
                <button id="publicAccessBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    Akses Publik (Cek Kehadiran)
                </button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden h-full flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg">
            <div class="p-6 border-b">
                <h1 class="text-xl font-bold text-gray-800">Dashboard Absensi</h1>
                <p id="userInfo" class="text-sm text-gray-600 mt-1"></p>
            </div>
            <nav class="mt-6">
                <div id="menuItems" class="space-y-2 px-4"></div>
            </nav>
            <div class="absolute bottom-4 left-4 right-4">
                <button id="logoutBtn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition duration-200">
                    Keluar
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <div class="p-6">
                <!-- Header -->
                <div class="mb-6">
                    <h2 id="pageTitle" class="text-2xl font-bold text-gray-800"></h2>
                    <p id="pageSubtitle" class="text-gray-600 mt-1"></p>
                </div>

                <!-- Content Area -->
                <div id="contentArea"></div>
            </div>
        </div>
    </div>

    <!-- Public Access -->
    <div id="publicAccess" class="hidden min-h-full flex items-center justify-center p-6">
        <div class="bg-white rounded-xl shadow-xl p-8 w-full max-w-2xl">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Cek Kehadiran Siswa</h2>
                <p class="text-gray-600">Masukkan nama atau NISN untuk melihat data kehadiran</p>
            </div>
            
            <div class="mb-6">
                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-2">Nama atau NISN</label>
                <div class="flex gap-3">
                    <input type="text" id="searchInput" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan nama atau NISN siswa">
                    <button id="searchBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200">
                        Cari
                    </button>
                </div>
            </div>

            <div id="searchResults" class="hidden">
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="font-semibold text-gray-800 mb-4">Data Kehadiran</h3>
                    <div id="attendanceData"></div>
                </div>
            </div>

            <div class="text-center mt-6">
                <button id="backToLogin" class="text-blue-600 hover:text-blue-800 font-medium">
                    Kembali ke Login
                </button>
            </div>
        </div>
    </div>

    <script>
        // Data Storage
        let currentUser = null;
        let students = [
            { id: 1, nisn: '1234567890', name: 'Ahmad Rizki', class: '10A', parentPhone: '081234567890' },
            { id: 2, nisn: '1234567891', name: 'Siti Nurhaliza', class: '10A', parentPhone: '081234567891' },
            { id: 3, nisn: '1234567892', name: 'Budi Santoso', class: '10B', parentPhone: '081234567892' }
        ];
        
        let teachers = [
            { id: 1, name: 'Pak Agus', subject: 'Matematika', code: 'GURU001' },
            { id: 2, name: 'Bu Sari', subject: 'Bahasa Indonesia', code: 'GURU002' },
            { id: 3, name: 'Pak Budi', subject: 'Fisika', code: 'GURU003' }
        ];
        
        let users = [
            { code: 'ADMIN001', role: 'admin', name: 'Administrator' },
            { code: 'GURU001', role: 'teacher', name: 'Pak Agus', subject: 'Matematika' },
            { code: 'GURU002', role: 'teacher', name: 'Bu Sari', subject: 'Bahasa Indonesia' },
            { code: 'WALI001', role: 'homeroom', name: 'Bu Rina', class: '10A' },
            { code: 'KEPSEK001', role: 'principal', name: 'Kepala Sekolah' }
        ];
        
        let attendanceData = [
            { studentId: 1, date: '2024-01-15', subject: 'Matematika', status: 'hadir', material: 'Aljabar Linear', teacherCode: 'GURU001', timestamp: '2024-01-15T08:00:00Z' },
            { studentId: 1, date: '2024-01-16', subject: 'Matematika', status: 'sakit', material: 'Trigonometri', teacherCode: 'GURU001', timestamp: '2024-01-16T08:00:00Z' },
            { studentId: 2, date: '2024-01-15', subject: 'Matematika', status: 'hadir', material: 'Aljabar Linear', teacherCode: 'GURU001', timestamp: '2024-01-15T08:00:00Z' },
            { studentId: 3, date: '2024-01-15', subject: 'Matematika', status: 'alpha', material: 'Aljabar Linear', teacherCode: 'GURU001', timestamp: '2024-01-15T08:00:00Z' },
            { studentId: 1, date: '2024-01-17', subject: 'Bahasa Indonesia', status: 'hadir', material: 'Puisi Modern', teacherCode: 'GURU002', timestamp: '2024-01-17T09:00:00Z' },
            { studentId: 2, date: '2024-01-17', subject: 'Bahasa Indonesia', status: 'alpha', material: 'Puisi Modern', teacherCode: 'GURU002', timestamp: '2024-01-17T09:00:00Z' },
            { studentId: 3, date: '2024-01-17', subject: 'Bahasa Indonesia', status: 'izin', material: 'Puisi Modern', teacherCode: 'GURU002', timestamp: '2024-01-17T09:00:00Z' },
            { studentId: 1, date: '2024-01-18', subject: 'Fisika', status: 'hadir', material: 'Gerak Lurus', teacherCode: 'GURU003', timestamp: '2024-01-18T10:00:00Z' },
            { studentId: 2, date: '2024-01-18', subject: 'Fisika', status: 'hadir', material: 'Gerak Lurus', teacherCode: 'GURU003', timestamp: '2024-01-18T10:00:00Z' },
            { studentId: 3, date: '2024-01-18', subject: 'Fisika', status: 'alpha', material: 'Gerak Lurus', teacherCode: 'GURU003', timestamp: '2024-01-18T10:00:00Z' },
            { studentId: 1, date: '2024-01-19', subject: 'Matematika', status: 'alpha', material: 'Kalkulus Dasar', teacherCode: 'GURU001', timestamp: '2024-01-19T08:00:00Z' },
            { studentId: 2, date: '2024-01-19', subject: 'Matematika', status: 'hadir', material: 'Kalkulus Dasar', teacherCode: 'GURU001', timestamp: '2024-01-19T08:00:00Z' },
            { studentId: 3, date: '2024-01-19', subject: 'Matematika', status: 'alpha', material: 'Kalkulus Dasar', teacherCode: 'GURU001', timestamp: '2024-01-19T08:00:00Z' },
            { studentId: 1, date: '2024-01-20', subject: 'Bahasa Indonesia', status: 'hadir', material: 'Cerpen Kontemporer', teacherCode: 'GURU002', timestamp: '2024-01-20T09:00:00Z' },
            { studentId: 2, date: '2024-01-20', subject: 'Bahasa Indonesia', status: 'sakit', material: 'Cerpen Kontemporer', teacherCode: 'GURU002', timestamp: '2024-01-20T09:00:00Z' },
            { studentId: 3, date: '2024-01-20', subject: 'Bahasa Indonesia', status: 'alpha', material: 'Cerpen Kontemporer', teacherCode: 'GURU002', timestamp: '2024-01-20T09:00:00Z' }
        ];

        // Location tracking
        let currentLocation = null;
        
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            currentLocation = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                timestamp: new Date().toISOString()
                            };
                            resolve(currentLocation);
                        },
                        error => reject(error),
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                    );
                } else {
                    reject(new Error('Geolocation tidak didukung'));
                }
            });
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const code = document.getElementById('userCode').value.trim();
            const user = users.find(u => u.code === code);
            
            if (user) {
                currentUser = user;
                showDashboard();
            } else {
                showNotification('Kode unik tidak valid!', 'error');
            }
        });

        document.getElementById('publicAccessBtn').addEventListener('click', function() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('publicAccess').classList.remove('hidden');
        });

        document.getElementById('backToLogin').addEventListener('click', function() {
            document.getElementById('publicAccess').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
        });

        // Dashboard functionality
        function showDashboard() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('userInfo').textContent = `${currentUser.name} (${currentUser.role.toUpperCase()})`;
            setupMenu();
            showHomePage();
        }

        function setupMenu() {
            const menuItems = document.getElementById('menuItems');
            menuItems.innerHTML = '';
            
            const menus = getMenusForRole(currentUser.role);
            menus.forEach(menu => {
                const menuItem = document.createElement('button');
                menuItem.className = 'w-full text-left px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200';
                menuItem.textContent = menu.label;
                menuItem.addEventListener('click', () => menu.action());
                menuItems.appendChild(menuItem);
            });
        }

        function getMenusForRole(role) {
            const baseMenus = [
                { label: 'Beranda', action: showHomePage }
            ];
            
            switch(role) {
                case 'admin':
                    return [
                        ...baseMenus,
                        { label: 'Kelola Siswa', action: showStudentManagement },
                        { label: 'Kelola Guru', action: showTeacherManagement },
                        { label: 'Kelola User', action: showUserManagement },
                        { label: 'Laporan Absensi', action: showAttendanceReport }
                    ];
                case 'teacher':
                    return [
                        ...baseMenus,
                        { label: 'Input Absensi', action: showAttendanceInput },
                        { label: 'Riwayat Absensi', action: showAttendanceHistory }
                    ];
                case 'homeroom':
                    return [
                        ...baseMenus,
                        { label: 'Monitoring Siswa', action: showStudentMonitoring },
                        { label: 'Kirim Notifikasi', action: showNotificationCenter }
                    ];
                case 'principal':
                    return [
                        ...baseMenus,
                        { label: 'Laporan Lengkap', action: showCompleteReport },
                        { label: 'Monitoring Kehadiran', action: showAttendanceMonitoring },
                        { label: 'Kirim Notifikasi', action: showNotificationCenter }
                    ];
                default:
                    return baseMenus;
            }
        }

        // Page functions
        function showHomePage() {
            document.getElementById('pageTitle').textContent = 'Beranda';
            document.getElementById('pageSubtitle').textContent = 'Selamat datang di sistem absensi sekolah';
            
            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 rounded-full">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Siswa</p>
                                <p class="text-2xl font-semibold text-gray-900">${students.length}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 rounded-full">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Hadir Hari Ini</p>
                                <p class="text-2xl font-semibold text-gray-900">${getTodayAttendance().present}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Tidak Hadir</p>
                                <p class="text-2xl font-semibold text-gray-900">${getTodayAttendance().absent}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-red-100 rounded-full">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Perlu Perhatian</p>
                                <p class="text-2xl font-semibold text-gray-900">${getStudentsNeedingAttention().length}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Aktivitas Terbaru</h3>
                    <div class="space-y-3">
                        ${getRecentActivities().map(activity => `
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">${activity.message}</p>
                                    <p class="text-xs text-gray-500">${activity.time}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Initialize filter statistics
            updateFilterStatistics();
        }

        function showAttendanceInput() {
            document.getElementById('pageTitle').textContent = 'Input Absensi';
            document.getElementById('pageSubtitle').textContent = 'Input kehadiran siswa untuk mata pelajaran Anda';
            
            const content = `
                <div class="bg-white rounded-lg shadow p-6">
                    <!-- Location and Camera Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-blue-800 mb-2">📍 Lokasi Saat Ini</h3>
                            <div id="currentLocationDisplay" class="text-sm text-blue-700">
                                <p>Mengambil lokasi...</p>
                            </div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-green-800 mb-2">📷 Dokumentasi</h3>
                            <button type="button" id="cameraBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 text-sm">
                                Ambil Foto Kelas
                            </button>
                            <div id="photoPreview" class="mt-2 hidden">
                                <img id="capturedPhoto" class="w-full h-32 object-cover rounded-lg border">
                            </div>
                        </div>
                    </div>
                    
                    <form id="attendanceForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="attendanceDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="attendanceDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label for="attendanceSubject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <input type="text" id="attendanceSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" value="${currentUser.subject}" readonly>
                            </div>
                        </div>
                        
                        <div>
                            <label for="materialTaught" class="block text-sm font-medium text-gray-700 mb-2">Materi yang Diajarkan</label>
                            <input type="text" id="materialTaught" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan materi atau sub materi yang diajarkan" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-4">Daftar Kehadiran Siswa</label>
                            <div class="space-y-3" id="studentAttendanceList">
                                ${students.map(student => `
                                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                        <div>
                                            <p class="font-medium text-gray-900">${student.name}</p>
                                            <p class="text-sm text-gray-500">NISN: ${student.nisn} | Kelas: ${student.class}</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <label class="flex items-center">
                                                <input type="radio" name="attendance_${student.id}" value="hadir" class="mr-2 text-green-600">
                                                <span class="text-sm text-green-600">Hadir</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="attendance_${student.id}" value="sakit" class="mr-2 text-yellow-600">
                                                <span class="text-sm text-yellow-600">Sakit</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="attendance_${student.id}" value="izin" class="mr-2 text-blue-600">
                                                <span class="text-sm text-blue-600">Izin</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="attendance_${student.id}" value="alpha" class="mr-2 text-red-600">
                                                <span class="text-sm text-red-600">Alpha</span>
                                            </label>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                Simpan Absensi
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Camera Modal -->
                <div id="cameraModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                        <div class="text-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Ambil Foto Dokumentasi</h3>
                        </div>
                        <div class="mb-4">
                            <video id="cameraVideo" class="w-full h-64 bg-gray-200 rounded-lg" autoplay playsinline></video>
                            <canvas id="cameraCanvas" class="hidden"></canvas>
                        </div>
                        <div class="flex justify-center space-x-3">
                            <button id="captureBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                📷 Ambil Foto
                            </button>
                            <button id="closeCameraBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Get location when loading attendance input
            getCurrentLocation().then(location => {
                document.getElementById('currentLocationDisplay').innerHTML = `
                    <p><strong>Latitude:</strong> ${location.latitude.toFixed(6)}</p>
                    <p><strong>Longitude:</strong> ${location.longitude.toFixed(6)}</p>
                    <p class="text-xs mt-1">Lokasi berhasil dideteksi ✅</p>
                `;
            }).catch(error => {
                document.getElementById('currentLocationDisplay').innerHTML = `
                    <p class="text-red-600">❌ Gagal mendapatkan lokasi</p>
                    <p class="text-xs">Pastikan GPS aktif</p>
                `;
                showNotification('Gagal mendapatkan lokasi. Pastikan GPS aktif.', 'error');
            });
            
            // Camera functionality
            setupCameraFeature();
            
            document.getElementById('attendanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveAttendance();
            });
        }

        function saveAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const subject = document.getElementById('attendanceSubject').value;
            const material = document.getElementById('materialTaught').value;
            
            if (!material.trim()) {
                showNotification('Harap isi materi yang diajarkan!', 'error');
                return;
            }
            
            students.forEach(student => {
                const statusElement = document.querySelector(`input[name="attendance_${student.id}"]:checked`);
                if (statusElement) {
                    const newAttendance = {
                        studentId: student.id,
                        date: date,
                        subject: subject,
                        status: statusElement.value,
                        material: material,
                        location: currentLocation,
                        teacherCode: currentUser.code,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Remove existing attendance for same date/subject/student
                    attendanceData = attendanceData.filter(a => 
                        !(a.studentId === student.id && a.date === date && a.subject === subject)
                    );
                    
                    attendanceData.push(newAttendance);
                }
            });
            
            showNotification('Absensi berhasil disimpan!', 'success');
            
            // Check for students needing attention
            checkStudentsNeedingAttention();
        }

        function showStudentMonitoring() {
            document.getElementById('pageTitle').textContent = 'Monitoring Siswa';
            document.getElementById('pageSubtitle').textContent = 'Pantau pola kehadiran siswa di kelas Anda dengan detail mata pelajaran';
            
            const classStudents = students.filter(s => s.class === currentUser.class);
            const studentsNeedingAttention = getStudentsNeedingAttention().filter(s => s.class === currentUser.class);
            const classStats = getClassAttendanceStats().find(c => c.class === currentUser.class);
            
            const content = `
                <!-- Statistik Kelas -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 rounded-full">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Hadir Hari Ini</p>
                                <p class="text-2xl font-semibold text-gray-900">${classStats ? classStats.hadir : 0}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Sakit</p>
                                <p class="text-2xl font-semibold text-gray-900">${classStats ? classStats.sakit : 0}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 rounded-full">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Izin</p>
                                <p class="text-2xl font-semibold text-gray-900">${classStats ? classStats.izin : 0}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-red-100 rounded-full">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Alpha</p>
                                <p class="text-2xl font-semibold text-gray-900">${classStats ? classStats.alpha : 0}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Siswa Bermasalah -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Siswa Perlu Perhatian Khusus</h3>
                            <p class="text-sm text-gray-600 mt-1">📅 Berdasarkan data 30 hari terakhir</p>
                        </div>
                        <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${studentsNeedingAttention.length} siswa</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        ${studentsNeedingAttention.map(student => `
                            <div class="border border-red-200 bg-red-50 rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="font-medium text-gray-900">${student.name}</p>
                                        <p class="text-sm text-gray-600">NISN: ${student.nisn}</p>
                                    </div>
                                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded">${student.alphaCount}x Alpha</span>
                                </div>
                                <div class="text-sm text-gray-600 mb-3">
                                    <p>Kategori: ${getAttentionCategory(student.alphaCount)}</p>
                                    <p>No. WA: ${student.parentPhone}</p>
                                </div>
                                <button onclick="sendWhatsAppNotification('${student.parentPhone}', '${student.name}', ${student.alphaCount})" class="w-full bg-green-600 text-white text-sm py-2 rounded hover:bg-green-700 transition duration-200">
                                    Kirim ke WhatsApp
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Kategori Siswa -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        ${getStudentCategoriesForClass(currentUser.class).map((category, index) => `
                            <div onclick="showCategoryDetail('${category.key}')" class="text-center p-4 border rounded-lg ${category.color} cursor-pointer hover:shadow-md transition-shadow duration-200">
                                <p class="text-2xl font-bold mb-1">${category.count}</p>
                                <p class="font-medium text-sm">${category.name}</p>
                                <p class="text-xs text-gray-600">${category.description}</p>
                                <p class="text-xs text-blue-600 mt-2">👆 Klik untuk detail</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Absensi Harian Kelas -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">📅 Absensi Harian Kelas ${currentUser.class}</h3>
                        <div class="flex gap-3">
                            <button onclick="downloadDailyExcel()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center gap-2">
                                📥 Download Harian Excel
                            </button>
                            <button onclick="downloadDailyPDF()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200 flex items-center gap-2">
                                📄 Download Harian PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-800">
                                    <strong>Keterangan:</strong> Absensi harian diambil dari data mata pelajaran yang masuk pertama kali di kelas pada hari tersebut.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="dailyFilterStartDate" class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                            <input type="date" id="dailyFilterStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="dailyFilterEndDate" class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                            <input type="date" id="dailyFilterEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="flex items-end">
                            <button id="dailyFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                🔍 Filter Harian
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ringkasan Statistik Harian -->
                    <div id="dailyAttendanceStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-gray-800" id="dailyTotalDays">0</p>
                            <p class="text-sm text-gray-600">Total Hari</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-green-600" id="dailyTotalHadir">0</p>
                            <p class="text-sm text-green-600">Hadir</p>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-yellow-600" id="dailyTotalSakit">0</p>
                            <p class="text-sm text-yellow-600">Sakit</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-blue-600" id="dailyTotalIzin">0</p>
                            <p class="text-sm text-blue-600">Izin</p>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-red-600" id="dailyTotalAlpha">0</p>
                            <p class="text-sm text-red-600">Alpha</p>
                        </div>
                    </div>
                    
                    <div id="dailyAttendanceResults">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Siswa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Harian</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="dailyAttendanceTableBody">
                                    ${generateDailyAttendanceData(currentUser.class)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Filter dan Download -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">📊 Absensi Lengkap per Mata Pelajaran</h3>
                        <div class="flex gap-3">
                            <button onclick="downloadClassExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center gap-2">
                                📥 Download Excel
                            </button>
                            <button onclick="downloadClassPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 flex items-center gap-2">
                                📄 Download PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label for="filterStartDate" class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                            <input type="date" id="filterStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="filterEndDate" class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                            <input type="date" id="filterEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="filterSubject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                            <select id="filterSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Semua Mata Pelajaran</option>
                                <option value="Matematika">Matematika</option>
                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                <option value="Fisika">Fisika</option>
                                <option value="Kimia">Kimia</option>
                                <option value="Biologi">Biologi</option>
                                <option value="Sejarah">Sejarah</option>
                                <option value="Geografi">Geografi</option>
                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="filterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                🔍 Filter Data
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ringkasan Statistik -->
                    <div id="attendanceStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-gray-800" id="totalRecords">0</p>
                            <p class="text-sm text-gray-600">Total Record</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-green-600" id="totalHadir">0</p>
                            <p class="text-sm text-green-600">Hadir</p>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-yellow-600" id="totalSakit">0</p>
                            <p class="text-sm text-yellow-600">Sakit</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-blue-600" id="totalIzin">0</p>
                            <p class="text-sm text-blue-600">Izin</p>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-red-600" id="totalAlpha">0</p>
                            <p class="text-sm text-red-600">Alpha</p>
                        </div>
                    </div>
                    
                    <div id="monitoringResults">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Siswa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="monitoringTableBody">
                                    ${generateDetailedMonitoringData(currentUser.class)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Update statistics
            updateAttendanceStatistics();
            updateDailyAttendanceStatistics();
            
            document.getElementById('filterBtn').addEventListener('click', function() {
                const startDate = document.getElementById('filterStartDate').value;
                const endDate = document.getElementById('filterEndDate').value;
                const subject = document.getElementById('filterSubject').value;
                updateDetailedMonitoringData(startDate, endDate, subject);
            });
            
            document.getElementById('dailyFilterBtn').addEventListener('click', function() {
                const startDate = document.getElementById('dailyFilterStartDate').value;
                const endDate = document.getElementById('dailyFilterEndDate').value;
                updateDailyAttendanceData(startDate, endDate);
            });
        }

        function showNotificationCenter() {
            document.getElementById('pageTitle').textContent = 'Pusat Notifikasi';
            document.getElementById('pageSubtitle').textContent = 'Kirim notifikasi WhatsApp ke wali murid';
            
            const studentsNeedingAttention = getStudentsNeedingAttention();
            const relevantStudents = currentUser.role === 'homeroom' ? 
                studentsNeedingAttention.filter(s => s.class === currentUser.class) : 
                studentsNeedingAttention;
            
            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Daftar Siswa Perlu Perhatian -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Siswa Perlu Perhatian Khusus</h3>
                        <div class="space-y-3">
                            ${relevantStudents.map(student => `
                                <div class="p-4 border border-red-200 bg-red-50 rounded-lg">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <p class="font-medium text-gray-900">${student.name}</p>
                                            <p class="text-sm text-gray-600">Kelas: ${student.class} | NISN: ${student.nisn}</p>
                                            <p class="text-sm text-gray-600">Alpha: ${student.alphaCount} kali</p>
                                            <p class="text-sm text-gray-600">📱 No. WA Ortu: ${student.parentPhone}</p>
                                        </div>
                                        <span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded">
                                            ${getAttentionCategory(student.alphaCount)}
                                        </span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="selectStudentForNotification(${student.id})" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 transition duration-200">
                                            📝 Pilih untuk Notifikasi
                                        </button>
                                        <button onclick="sendQuickWhatsAppNotification('${student.parentPhone}', '${student.name}', ${student.alphaCount}, '${student.class}')" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700 transition duration-200">
                                            💬 Kirim Langsung
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${relevantStudents.length === 0 ? `
                                <div class="text-center py-8 text-gray-500">
                                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <p>Tidak ada siswa yang memerlukan perhatian khusus</p>
                                    <p class="text-sm">Semua siswa memiliki kehadiran yang baik</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Form Notifikasi -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Form Kirim Notifikasi</h3>
                        <form id="notificationForm" class="space-y-4">
                            <div>
                                <label for="selectedStudent" class="block text-sm font-medium text-gray-700 mb-2">Pilih Siswa</label>
                                <select id="selectedStudent" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="updateParentContact()">
                                    <option value="">-- Pilih Siswa --</option>
                                    ${relevantStudents.map(student => `
                                        <option value="${student.id}" data-phone="${student.parentPhone}" data-alpha="${student.alphaCount}" data-class="${student.class}">
                                            ${student.name} (${student.class}) - ${student.alphaCount}x Alpha
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label for="parentContact" class="block text-sm font-medium text-gray-700 mb-2">Nomor WhatsApp Orang Tua</label>
                                <input type="tel" id="parentContact" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Pilih siswa untuk mengisi otomatis" readonly>
                            </div>
                            
                            <div>
                                <label for="messageTemplate" class="block text-sm font-medium text-gray-700 mb-2">Template Pesan</label>
                                <textarea id="messageTemplate" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">Assalamu'alaikum Wr. Wb.

Yth. Bapak/Ibu Wali Murid,

Kami dari pihak sekolah ingin menginformasikan bahwa putra/putri Anda:

Nama: [NAMA_SISWA]
Kelas: [KELAS_SISWA]

Telah tidak hadir tanpa keterangan (alpha) sebanyak [JUMLAH_ALPHA] kali.

Kami mohon perhatian dan kerja sama Bapak/Ibu untuk memantau kehadiran putra/putri Anda di sekolah.

Terima kasih atas perhatiannya.

Wassalamu'alaikum Wr. Wb.

[NAMA_PENGIRIM]
${currentUser.role === 'principal' ? 'Kepala Sekolah' : currentUser.role === 'homeroom' ? `Wali Kelas ${currentUser.class}` : 'Guru'}</textarea>
                            </div>
                            
                            <div class="flex gap-3">
                                <button type="button" onclick="previewNotificationMessage()" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition duration-200">
                                    👁️ Preview Pesan
                                </button>
                                <button type="button" onclick="sendCustomWhatsAppNotification()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                    📱 Kirim ke WhatsApp
                                </button>
                            </div>
                        </form>
                        
                        <!-- Preview Pesan -->
                        <div id="messagePreview" class="hidden mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium text-blue-800">📱 Preview Pesan WhatsApp</h4>
                                <button onclick="closePreview()" class="text-blue-600 hover:text-blue-800">✕</button>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <div id="previewContent" class="text-sm text-gray-700 whitespace-pre-line"></div>
                            </div>
                            <div class="mt-3 text-xs text-blue-600">
                                <p>📞 Akan dikirim ke: <span id="previewPhone" class="font-medium"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Riwayat Notifikasi -->
                <div class="bg-white rounded-lg shadow p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Riwayat Notifikasi Hari Ini</h3>
                    <div id="notificationHistory" class="space-y-2">
                        <div class="text-center py-4 text-gray-500">
                            <p class="text-sm">Belum ada notifikasi yang dikirim hari ini</p>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Initialize filter statistics
            updateFilterStatistics();
        }

        // Public search functionality
        document.getElementById('searchBtn').addEventListener('click', function() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                showNotification('Masukkan nama atau NISN untuk mencari!', 'error');
                return;
            }
            
            const student = students.find(s => 
                s.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                s.nisn === searchTerm
            );
            
            if (student) {
                displayPublicAttendanceData(student);
            } else {
                showNotification('Data siswa tidak ditemukan!', 'error');
            }
        });

        function displayPublicAttendanceData(student) {
            const studentAttendance = attendanceData.filter(a => a.studentId === student.id);
            const results = document.getElementById('searchResults');
            const dataDiv = document.getElementById('attendanceData');
            
            const attendanceSummary = {
                hadir: studentAttendance.filter(a => a.status === 'hadir').length,
                sakit: studentAttendance.filter(a => a.status === 'sakit').length,
                izin: studentAttendance.filter(a => a.status === 'izin').length,
                alpha: studentAttendance.filter(a => a.status === 'alpha').length
            };
            
            dataDiv.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-800">${student.name}</h4>
                    <p class="text-sm text-gray-600">NISN: ${student.nisn} | Kelas: ${student.class}</p>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center p-3 bg-green-100 rounded-lg">
                        <p class="text-2xl font-bold text-green-600">${attendanceSummary.hadir}</p>
                        <p class="text-sm text-green-600">Hadir</p>
                    </div>
                    <div class="text-center p-3 bg-yellow-100 rounded-lg">
                        <p class="text-2xl font-bold text-yellow-600">${attendanceSummary.sakit}</p>
                        <p class="text-sm text-yellow-600">Sakit</p>
                    </div>
                    <div class="text-center p-3 bg-blue-100 rounded-lg">
                        <p class="text-2xl font-bold text-blue-600">${attendanceSummary.izin}</p>
                        <p class="text-sm text-blue-600">Izin</p>
                    </div>
                    <div class="text-center p-3 bg-red-100 rounded-lg">
                        <p class="text-2xl font-bold text-red-600">${attendanceSummary.alpha}</p>
                        <p class="text-sm text-red-600">Alpha</p>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <h5 class="font-medium text-gray-800">Riwayat Kehadiran Terbaru:</h5>
                    ${studentAttendance.slice(-5).reverse().map(attendance => `
                        <div class="flex justify-between items-center p-2 bg-white border rounded">
                            <div>
                                <span class="text-sm font-medium">${attendance.subject}</span>
                                <span class="text-xs text-gray-500 ml-2">${attendance.date}</span>
                            </div>
                            <span class="px-2 py-1 text-xs rounded ${getStatusColor(attendance.status)}">
                                ${attendance.status.toUpperCase()}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            results.classList.remove('hidden');
        }

        // Utility functions
        function getTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendanceData.filter(a => a.date === today);
            
            return {
                present: todayAttendance.filter(a => a.status === 'hadir').length,
                absent: todayAttendance.filter(a => a.status !== 'hadir').length
            };
        }

        function getStudentsNeedingAttention() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const thirtyDaysAgoString = thirtyDaysAgo.toISOString().split('T')[0];
            
            return students.map(student => {
                const alphaCount = attendanceData.filter(a => 
                    a.studentId === student.id && 
                    a.status === 'alpha' && 
                    a.date >= thirtyDaysAgoString
                ).length;
                
                return {
                    ...student,
                    alphaCount
                };
            }).filter(student => student.alphaCount >= 3);
        }

        function getRecentActivities() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const thirtyDaysAgoString = thirtyDaysAgo.toISOString().split('T')[0];
            
            const recentAlphaStudents = attendanceData
                .filter(a => a.status === 'alpha' && a.date >= thirtyDaysAgoString)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5)
                .map(a => {
                    const student = students.find(s => s.id === a.studentId);
                    return {
                        message: `${student.name} tidak hadir (alpha) di ${a.subject}`,
                        time: formatTimeAgo(a.date)
                    };
                });
            
            const recentAttendanceInputs = attendanceData
                .filter(a => a.date >= thirtyDaysAgoString)
                .sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date))
                .slice(0, 3)
                .map(a => {
                    const teacher = users.find(u => u.code === a.teacherCode);
                    return {
                        message: `${teacher ? teacher.name : 'Guru'} input absensi ${a.subject}`,
                        time: formatTimeAgo(a.date)
                    };
                });
            
            const defaultActivities = [
                { message: 'Sistem monitoring aktif (30 hari terakhir)', time: 'Real-time' }
            ];
            
            const allActivities = [...recentAlphaStudents, ...recentAttendanceInputs, ...defaultActivities];
            return allActivities.slice(0, 5);
        }

        // Camera functionality
        function setupCameraFeature() {
            const cameraBtn = document.getElementById('cameraBtn');
            const cameraModal = document.getElementById('cameraModal');
            const closeCameraBtn = document.getElementById('closeCameraBtn');
            const captureBtn = document.getElementById('captureBtn');
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            
            let stream = null;
            
            cameraBtn.addEventListener('click', async function() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } // Use back camera if available
                    });
                    video.srcObject = stream;
                    cameraModal.classList.remove('hidden');
                } catch (error) {
                    showNotification('Tidak dapat mengakses kamera. Pastikan izin kamera diberikan.', 'error');
                }
            });
            
            closeCameraBtn.addEventListener('click', function() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                cameraModal.classList.add('hidden');
            });
            
            captureBtn.addEventListener('click', function() {
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                
                const photoData = canvas.toDataURL('image/jpeg', 0.8);
                document.getElementById('capturedPhoto').src = photoData;
                document.getElementById('photoPreview').classList.remove('hidden');
                
                // Stop camera
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                cameraModal.classList.add('hidden');
                
                showNotification('Foto berhasil diambil!', 'success');
            });
        }

        // Utility functions for new features
        function getTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendanceData.filter(a => a.date === today);
            
            return {
                present: todayAttendance.filter(a => a.status === 'hadir').length,
                absent: todayAttendance.filter(a => a.status !== 'hadir').length,
                izin: todayAttendance.filter(a => a.status === 'izin').length,
                sakit: todayAttendance.filter(a => a.status === 'sakit').length,
                alpha: todayAttendance.filter(a => a.status === 'alpha').length
            };
        }

        function getTeacherAttendanceToday() {
            const today = new Date().toISOString().split('T')[0];
            return teachers.map(teacher => {
                const todayAttendance = attendanceData.find(a => 
                    a.date === today && a.teacherCode === teacher.code
                );
                return {
                    ...teacher,
                    status: todayAttendance ? 'aktif' : 'tidak aktif',
                    lastMaterial: todayAttendance ? todayAttendance.material : null
                };
            });
        }

        function getClassAttendanceStats() {
            const classes = ['10A', '10B', '11A', '11B'];
            return classes.map(className => {
                const classStudents = students.filter(s => s.class === className);
                const today = new Date().toISOString().split('T')[0];
                const todayAttendance = attendanceData.filter(a => 
                    a.date === today && classStudents.some(s => s.id === a.studentId)
                );
                
                return {
                    class: className,
                    total: classStudents.length,
                    hadir: todayAttendance.filter(a => a.status === 'hadir').length,
                    sakit: todayAttendance.filter(a => a.status === 'sakit').length,
                    izin: todayAttendance.filter(a => a.status === 'izin').length,
                    alpha: todayAttendance.filter(a => a.status === 'alpha').length
                };
            });
        }

        function getStudentCategories() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const thirtyDaysAgoString = thirtyDaysAgo.toISOString().split('T')[0];
            
            const studentsWithAlpha = students.map(student => {
                const alphaCount = attendanceData.filter(a => 
                    a.studentId === student.id && 
                    a.status === 'alpha' && 
                    a.date >= thirtyDaysAgoString
                ).length;
                return { ...student, alphaCount };
            });
            
            return [
                {
                    name: 'Sangat Bermasalah',
                    description: 'Alpha 7+ kali (30 hari terakhir)',
                    count: studentsWithAlpha.filter(s => s.alphaCount >= 7).length,
                    color: 'bg-red-100 border-red-200'
                },
                {
                    name: 'Perlu Perhatian',
                    description: 'Alpha 3-6 kali (30 hari terakhir)',
                    count: studentsWithAlpha.filter(s => s.alphaCount >= 3 && s.alphaCount < 7).length,
                    color: 'bg-yellow-100 border-yellow-200'
                },
                {
                    name: 'Mulai Bermasalah',
                    description: 'Alpha 1-2 kali (30 hari terakhir)',
                    count: studentsWithAlpha.filter(s => s.alphaCount >= 1 && s.alphaCount < 3).length,
                    color: 'bg-orange-100 border-orange-200'
                },
                {
                    name: 'Normal',
                    description: 'Tidak ada alpha (30 hari terakhir)',
                    count: studentsWithAlpha.filter(s => s.alphaCount === 0).length,
                    color: 'bg-green-100 border-green-200'
                }
            ];
        }

        function getAttentionCategory(alphaCount) {
            if (alphaCount >= 7) return 'Sangat Bermasalah';
            if (alphaCount >= 3) return 'Perlu Perhatian';
            if (alphaCount >= 1) return 'Mulai Bermasalah';
            return 'Normal';
        }

        function sendWhatsAppNotification(phone, studentName, alphaCount) {
            const message = encodeURIComponent(`Yth. Bapak/Ibu Wali Murid,

Kami informasikan bahwa putra/putri Anda ${studentName} telah tidak hadir tanpa keterangan (alpha) sebanyak ${alphaCount} kali.

Mohon perhatian dan tindak lanjut dari Bapak/Ibu.

Terima kasih.

${currentUser.name}
${currentUser.role === 'principal' ? 'Kepala Sekolah' : 'Wali Kelas'}`);
            
            const whatsappUrl = `https://wa.me/${phone.replace(/^0/, '62')}?text=${message}`;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
            
            showNotification(`Membuka WhatsApp untuk ${studentName}...`, 'success');
        }

        // Global variable to store filtered data
        let filteredAttendanceData = [...attendanceData];
        
        function generateAttendanceReportTable(data = null) {
            const dataToShow = data || filteredAttendanceData;
            
            return dataToShow.map(attendance => {
                const student = students.find(s => s.id === attendance.studentId);
                const teacher = users.find(u => u.code === attendance.teacherCode);
                const locationText = attendance.location ? 
                    `${attendance.location.latitude.toFixed(4)}, ${attendance.location.longitude.toFixed(4)}` : 
                    'Tidak ada data';
                
                return `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${attendance.date}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${student.nisn}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${student.class}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${attendance.subject}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(attendance.status)}">
                                ${attendance.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 max-w-xs truncate" title="${attendance.material || '-'}">${attendance.material || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${teacher ? teacher.name : 'Unknown'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                            <button onclick="editLocation('${attendance.studentId}', '${attendance.date}', '${attendance.subject}')" class="text-blue-600 hover:text-blue-900 text-xs">
                                ${locationText}
                            </button>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button onclick="editAttendance('${attendance.studentId}', '${attendance.date}', '${attendance.subject}')" class="text-blue-600 hover:text-blue-900 mr-2 text-xs">Edit</button>
                            <button onclick="deleteAttendance('${attendance.studentId}', '${attendance.date}', '${attendance.subject}')" class="text-red-600 hover:text-red-900 text-xs">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function applyAttendanceFilters() {
            const studentName = document.getElementById('filterStudentName').value.toLowerCase().trim();
            const className = document.getElementById('filterClass').value;
            const subject = document.getElementById('filterSubject').value;
            const status = document.getElementById('filterStatus').value;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const nisn = document.getElementById('filterNISN').value.trim();
            
            // Start with all attendance data
            filteredAttendanceData = attendanceData.filter(attendance => {
                const student = students.find(s => s.id === attendance.studentId);
                if (!student) return false;
                
                // Filter by student name
                if (studentName && !student.name.toLowerCase().includes(studentName)) {
                    return false;
                }
                
                // Filter by NISN
                if (nisn && !student.nisn.includes(nisn)) {
                    return false;
                }
                
                // Filter by class
                if (className && student.class !== className) {
                    return false;
                }
                
                // Filter by subject
                if (subject && attendance.subject !== subject) {
                    return false;
                }
                
                // Filter by status
                if (status && attendance.status !== status) {
                    return false;
                }
                
                // Filter by date range
                if (startDate && attendance.date < startDate) {
                    return false;
                }
                
                if (endDate && attendance.date > endDate) {
                    return false;
                }
                
                return true;
            });
            
            // Sort by date descending
            filteredAttendanceData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Update table and statistics
            updateAttendanceReportTable();
            updateFilterStatistics();
            
            showNotification(`Filter diterapkan! Ditemukan ${filteredAttendanceData.length} data.`, 'success');
        }
        
        function resetAttendanceFilters() {
            // Clear all filter inputs
            document.getElementById('filterStudentName').value = '';
            document.getElementById('filterClass').value = '';
            document.getElementById('filterSubject').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterNISN').value = '';
            
            // Reset filtered data to all data
            filteredAttendanceData = [...attendanceData];
            filteredAttendanceData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Update table and statistics
            updateAttendanceReportTable();
            updateFilterStatistics();
            
            showNotification('Filter direset! Menampilkan semua data.', 'info');
        }
        
        function setQuickFilter(type) {
            // Reset filters first
            resetAttendanceFilters();
            
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            
            switch(type) {
                case 'today':
                    document.getElementById('filterStartDate').value = todayString;
                    document.getElementById('filterEndDate').value = todayString;
                    break;
                    
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6); // End of week (Saturday)
                    
                    document.getElementById('filterStartDate').value = weekStart.toISOString().split('T')[0];
                    document.getElementById('filterEndDate').value = weekEnd.toISOString().split('T')[0];
                    break;
                    
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    
                    document.getElementById('filterStartDate').value = monthStart.toISOString().split('T')[0];
                    document.getElementById('filterEndDate').value = monthEnd.toISOString().split('T')[0];
                    break;
                    
                case 'alpha':
                    document.getElementById('filterStatus').value = 'alpha';
                    break;
                    
                case 'absent':
                    // This will be handled in the filter function by checking for non-hadir status
                    break;
            }
            
            // Apply the quick filter
            if (type === 'absent') {
                // Special handling for absent filter
                filteredAttendanceData = attendanceData.filter(attendance => 
                    attendance.status !== 'hadir'
                );
            } else {
                applyAttendanceFilters();
                return; // applyAttendanceFilters already updates the table
            }
            
            // Sort and update for absent filter
            filteredAttendanceData.sort((a, b) => new Date(b.date) - new Date(a.date));
            updateAttendanceReportTable();
            updateFilterStatistics();
            
            const filterNames = {
                'today': 'Hari Ini',
                'week': 'Minggu Ini', 
                'month': 'Bulan Ini',
                'alpha': 'Hanya Alpha',
                'absent': 'Tidak Hadir'
            };
            
            showNotification(`Filter ${filterNames[type]} diterapkan! Ditemukan ${filteredAttendanceData.length} data.`, 'success');
        }
        
        function updateAttendanceReportTable() {
            const tableBody = document.getElementById('attendanceReportTable');
            if (tableBody) {
                tableBody.innerHTML = generateAttendanceReportTable(filteredAttendanceData);
            }
        }
        
        function updateFilterStatistics() {
            const stats = {
                total: filteredAttendanceData.length,
                hadir: filteredAttendanceData.filter(a => a.status === 'hadir').length,
                sakit: filteredAttendanceData.filter(a => a.status === 'sakit').length,
                izin: filteredAttendanceData.filter(a => a.status === 'izin').length,
                alpha: filteredAttendanceData.filter(a => a.status === 'alpha').length
            };
            
            const percentage = stats.total > 0 ? Math.round((stats.hadir / stats.total) * 100) : 0;
            
            // Update DOM elements
            const totalElement = document.getElementById('totalFilteredRecords');
            const hadirElement = document.getElementById('filteredHadir');
            const sakitElement = document.getElementById('filteredSakit');
            const izinElement = document.getElementById('filteredIzin');
            const alphaElement = document.getElementById('filteredAlpha');
            const percentageElement = document.getElementById('filteredPercentage');
            
            if (totalElement) totalElement.textContent = stats.total;
            if (hadirElement) hadirElement.textContent = stats.hadir;
            if (sakitElement) sakitElement.textContent = stats.sakit;
            if (izinElement) izinElement.textContent = stats.izin;
            if (alphaElement) alphaElement.textContent = stats.alpha;
            if (percentageElement) percentageElement.textContent = percentage + '%';
        }
        
        function downloadFilteredExcel() {
            if (filteredAttendanceData.length === 0) {
                showNotification('Tidak ada data untuk didownload!', 'error');
                return;
            }
            
            // Prepare data for Excel
            const excelData = filteredAttendanceData.map(attendance => {
                const student = students.find(s => s.id === attendance.studentId);
                const teacher = users.find(u => u.code === attendance.teacherCode);
                return {
                    'Tanggal': attendance.date,
                    'Nama Siswa': student.name,
                    'NISN': student.nisn,
                    'Kelas': student.class,
                    'Mata Pelajaran': attendance.subject,
                    'Status Kehadiran': attendance.status.toUpperCase(),
                    'Materi': attendance.material || '',
                    'Guru Pengajar': teacher ? teacher.name : 'Unknown',
                    'Kode Guru': attendance.teacherCode || '',
                    'No. WA Ortu': student.parentPhone,
                    'Lokasi': attendance.location ? `${attendance.location.latitude}, ${attendance.location.longitude}` : '',
                    'Waktu Input': attendance.timestamp || ''
                };
            });
            
            // Create summary data
            const uniqueStudents = [...new Set(filteredAttendanceData.map(a => a.studentId))];
            const summaryData = uniqueStudents.map(studentId => {
                const student = students.find(s => s.id === studentId);
                const studentAttendance = filteredAttendanceData.filter(a => a.studentId === studentId);
                
                return {
                    'Nama Siswa': student.name,
                    'NISN': student.nisn,
                    'Kelas': student.class,
                    'No. WA Ortu': student.parentPhone,
                    'Total Hadir': studentAttendance.filter(a => a.status === 'hadir').length,
                    'Total Sakit': studentAttendance.filter(a => a.status === 'sakit').length,
                    'Total Izin': studentAttendance.filter(a => a.status === 'izin').length,
                    'Total Alpha': studentAttendance.filter(a => a.status === 'alpha').length,
                    'Total Kehadiran': studentAttendance.length,
                    'Persentase Hadir': studentAttendance.length > 0 ? 
                        Math.round((studentAttendance.filter(a => a.status === 'hadir').length / studentAttendance.length) * 100) + '%' : '0%'
                };
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Add detailed sheet
            const ws1 = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Detail Absensi');
            
            // Add summary sheet
            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Ringkasan Siswa');
            
            // Download file
            const fileName = `Laporan_Absensi_Filtered_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification(`File Excel "${fileName}" berhasil didownload!`, 'success');
        }
        
        function downloadFilteredPDF() {
            if (filteredAttendanceData.length === 0) {
                showNotification('Tidak ada data untuk didownload!', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Absensi Siswa</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 10px; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .status-hadir { background-color: #d4edda; }
                        .status-sakit { background-color: #fff3cd; }
                        .status-izin { background-color: #d1ecf1; }
                        .status-alpha { background-color: #f8d7da; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>LAPORAN ABSENSI SISWA</h1>
                        <p>Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}</p>
                        <p>Total Data: ${filteredAttendanceData.length} record</p>
                    </div>
                    
                    <div class="summary">
                        <h3>Ringkasan Kehadiran</h3>
                        <table style="width: 50%;">
                            <tr>
                                <th>Status</th>
                                <th>Jumlah</th>
                                <th>Persentase</th>
                            </tr>
                            <tr class="status-hadir">
                                <td>Hadir</td>
                                <td>${filteredAttendanceData.filter(a => a.status === 'hadir').length}</td>
                                <td>${filteredAttendanceData.length > 0 ? Math.round((filteredAttendanceData.filter(a => a.status === 'hadir').length / filteredAttendanceData.length) * 100) : 0}%</td>
                            </tr>
                            <tr class="status-sakit">
                                <td>Sakit</td>
                                <td>${filteredAttendanceData.filter(a => a.status === 'sakit').length}</td>
                                <td>${filteredAttendanceData.length > 0 ? Math.round((filteredAttendanceData.filter(a => a.status === 'sakit').length / filteredAttendanceData.length) * 100) : 0}%</td>
                            </tr>
                            <tr class="status-izin">
                                <td>Izin</td>
                                <td>${filteredAttendanceData.filter(a => a.status === 'izin').length}</td>
                                <td>${filteredAttendanceData.length > 0 ? Math.round((filteredAttendanceData.filter(a => a.status === 'izin').length / filteredAttendanceData.length) * 100) : 0}%</td>
                            </tr>
                            <tr class="status-alpha">
                                <td>Alpha</td>
                                <td>${filteredAttendanceData.filter(a => a.status === 'alpha').length}</td>
                                <td>${filteredAttendanceData.length > 0 ? Math.round((filteredAttendanceData.filter(a => a.status === 'alpha').length / filteredAttendanceData.length) * 100) : 0}%</td>
                            </tr>
                        </table>
                    </div>
                    
                    <h3>Detail Absensi</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Nama</th>
                                <th>NISN</th>
                                <th>Kelas</th>
                                <th>Mapel</th>
                                <th>Status</th>
                                <th>Materi</th>
                                <th>Guru</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredAttendanceData.map(attendance => {
                                const student = students.find(s => s.id === attendance.studentId);
                                const teacher = users.find(u => u.code === attendance.teacherCode);
                                return `
                                    <tr class="status-${attendance.status}">
                                        <td>${attendance.date}</td>
                                        <td>${student.name}</td>
                                        <td>${student.nisn}</td>
                                        <td>${student.class}</td>
                                        <td>${attendance.subject}</td>
                                        <td>${attendance.status.toUpperCase()}</td>
                                        <td>${(attendance.material || '').substring(0, 30)}${attendance.material && attendance.material.length > 30 ? '...' : ''}</td>
                                        <td>${teacher ? teacher.name : 'Unknown'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                showNotification('Dokumen PDF siap untuk dicetak atau disimpan!', 'success');
            }, 500);
        }

        function generateHistoryTable() {
            const teacherAttendance = attendanceData.filter(a => 
                a.teacherCode === currentUser.code
            );
            
            return teacherAttendance.map(attendance => {
                const student = students.find(s => s.id === attendance.studentId);
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.class}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(attendance.status)}">
                                ${attendance.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.material || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function getRoleColor(role) {
            switch(role) {
                case 'admin': return 'bg-purple-100 text-purple-800';
                case 'teacher': return 'bg-blue-100 text-blue-800';
                case 'homeroom': return 'bg-green-100 text-green-800';
                case 'principal': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getRoleLabel(role) {
            switch(role) {
                case 'admin': return 'Administrator';
                case 'teacher': return 'Guru';
                case 'homeroom': return 'Wali Kelas';
                case 'principal': return 'Kepala Sekolah';
                default: return 'Unknown';
            }
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Kemarin';
            if (diffDays < 7) return `${diffDays} hari yang lalu`;
            return `${Math.floor(diffDays / 7)} minggu yang lalu`;
        }

        // Modal and form functions
        let editingStudentId = null;
        let editingTeacherId = null;
        let editingUserCode = null;

        function showAddStudentModal() {
            editingStudentId = null;
            document.getElementById('studentModal').classList.remove('hidden');
            document.getElementById('studentModalTitle').textContent = 'Tambah Siswa';
            document.getElementById('studentForm').reset();
        }

        function closeStudentModal() {
            document.getElementById('studentModal').classList.add('hidden');
            editingStudentId = null;
        }

        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                editingStudentId = studentId;
                document.getElementById('studentNISN').value = student.nisn;
                document.getElementById('studentName').value = student.name;
                document.getElementById('studentClass').value = student.class;
                document.getElementById('parentPhone').value = student.parentPhone;
                document.getElementById('studentModalTitle').textContent = 'Edit Siswa';
                document.getElementById('studentModal').classList.remove('hidden');
            }
        }

        function deleteStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            const confirmMessage = `Apakah Anda yakin ingin menghapus data siswa "${student.name}"?\n\nData absensi siswa ini juga akan terhapus.`;
            
            if (confirm(confirmMessage)) {
                // Remove student
                students = students.filter(s => s.id !== studentId);
                // Remove attendance data
                attendanceData = attendanceData.filter(a => a.studentId !== studentId);
                
                showNotification('Data siswa berhasil dihapus!', 'success');
                showStudentManagement(); // Refresh the page
            }
        }

        // Teacher Management Functions
        function showAddTeacherModal() {
            editingTeacherId = null;
            document.getElementById('teacherModal').classList.remove('hidden');
            document.getElementById('teacherModalTitle').textContent = 'Tambah Guru';
            document.getElementById('teacherForm').reset();
        }

        function closeTeacherModal() {
            document.getElementById('teacherModal').classList.add('hidden');
            editingTeacherId = null;
        }

        function editTeacher(teacherId) {
            const teacher = teachers.find(t => t.id === teacherId);
            if (teacher) {
                editingTeacherId = teacherId;
                document.getElementById('teacherName').value = teacher.name;
                document.getElementById('teacherSubject').value = teacher.subject;
                document.getElementById('teacherCode').value = teacher.code;
                document.getElementById('teacherModalTitle').textContent = 'Edit Guru';
                document.getElementById('teacherModal').classList.remove('hidden');
            }
        }

        function deleteTeacher(teacherId) {
            const teacher = teachers.find(t => t.id === teacherId);
            const confirmMessage = `Apakah Anda yakin ingin menghapus data guru "${teacher.name}"?\n\nData absensi yang diinput oleh guru ini akan tetap ada.`;
            
            if (confirm(confirmMessage)) {
                // Remove teacher
                teachers = teachers.filter(t => t.id !== teacherId);
                // Remove from users array
                users = users.filter(u => u.code !== teacher.code);
                
                showNotification('Data guru berhasil dihapus!', 'success');
                showTeacherManagement(); // Refresh the page
            }
        }

        // User Management Functions
        function showAddUserModal() {
            editingUserCode = null;
            document.getElementById('userModal').classList.remove('hidden');
            document.getElementById('userModalTitle').textContent = 'Tambah User';
            document.getElementById('userForm').reset();
            toggleUserDetails(); // Hide conditional fields
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
            editingUserCode = null;
        }

        function toggleUserDetails() {
            const role = document.getElementById('userRole').value;
            const teacherDiv = document.getElementById('teacherSubjectDiv');
            const homeroomDiv = document.getElementById('homeroomClassDiv');
            
            // Hide all conditional fields first
            teacherDiv.classList.add('hidden');
            homeroomDiv.classList.add('hidden');
            
            // Show relevant fields based on role
            if (role === 'teacher') {
                teacherDiv.classList.remove('hidden');
            } else if (role === 'homeroom') {
                homeroomDiv.classList.remove('hidden');
            }
        }

        function editUser(userCode) {
            const user = users.find(u => u.code === userCode);
            if (user) {
                editingUserCode = userCode;
                document.getElementById('userCodeInput').value = user.code;
                document.getElementById('userName').value = user.name;
                document.getElementById('userRole').value = user.role;
                
                // Set conditional fields
                if (user.subject) {
                    document.getElementById('userSubject').value = user.subject;
                }
                if (user.class) {
                    document.getElementById('userClass').value = user.class;
                }
                
                toggleUserDetails(); // Show/hide relevant fields
                document.getElementById('userModalTitle').textContent = 'Edit User';
                document.getElementById('userModal').classList.remove('hidden');
            }
        }

        function deleteUser(userCode) {
            const user = users.find(u => u.code === userCode);
            
            // Prevent deleting current admin
            if (userCode === currentUser.code) {
                showNotification('Tidak dapat menghapus akun yang sedang digunakan!', 'error');
                return;
            }
            
            const confirmMessage = `Apakah Anda yakin ingin menghapus user "${user.name}" (${user.code})?`;
            
            if (confirm(confirmMessage)) {
                // Remove user
                users = users.filter(u => u.code !== userCode);
                
                showNotification('Data user berhasil dihapus!', 'success');
                showUserManagement(); // Refresh the page
            }
        }

        // Form Submit Handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Student Form Handler
            document.addEventListener('submit', function(e) {
                if (e.target.id === 'studentForm') {
                    e.preventDefault();
                    
                    const nisn = document.getElementById('studentNISN').value;
                    const name = document.getElementById('studentName').value;
                    const studentClass = document.getElementById('studentClass').value;
                    const parentPhone = document.getElementById('parentPhone').value;
                    
                    // Validate NISN uniqueness (except when editing)
                    const existingStudent = students.find(s => s.nisn === nisn && s.id !== editingStudentId);
                    if (existingStudent) {
                        showNotification('NISN sudah digunakan oleh siswa lain!', 'error');
                        return;
                    }
                    
                    if (editingStudentId) {
                        // Edit existing student
                        const student = students.find(s => s.id === editingStudentId);
                        student.nisn = nisn;
                        student.name = name;
                        student.class = studentClass;
                        student.parentPhone = parentPhone;
                        
                        showNotification('Data siswa berhasil diperbarui!', 'success');
                    } else {
                        // Add new student
                        const newStudent = {
                            id: Math.max(...students.map(s => s.id)) + 1,
                            nisn: nisn,
                            name: name,
                            class: studentClass,
                            parentPhone: parentPhone
                        };
                        students.push(newStudent);
                        
                        showNotification('Siswa berhasil ditambahkan!', 'success');
                    }
                    
                    closeStudentModal();
                    showStudentManagement();
                }
                
                // Teacher Form Handler
                if (e.target.id === 'teacherForm') {
                    e.preventDefault();
                    
                    const name = document.getElementById('teacherName').value;
                    const subject = document.getElementById('teacherSubject').value;
                    const code = document.getElementById('teacherCode').value;
                    
                    // Validate code uniqueness (except when editing)
                    const existingUser = users.find(u => u.code === code && u.code !== (editingTeacherId ? teachers.find(t => t.id === editingTeacherId)?.code : null));
                    if (existingUser) {
                        showNotification('Kode user sudah digunakan!', 'error');
                        return;
                    }
                    
                    if (editingTeacherId) {
                        // Edit existing teacher
                        const teacher = teachers.find(t => t.id === editingTeacherId);
                        const oldCode = teacher.code;
                        
                        teacher.name = name;
                        teacher.subject = subject;
                        teacher.code = code;
                        
                        // Update in users array
                        const user = users.find(u => u.code === oldCode);
                        if (user) {
                            user.code = code;
                            user.name = name;
                            user.subject = subject;
                        }
                        
                        showNotification('Data guru berhasil diperbarui!', 'success');
                    } else {
                        // Add new teacher
                        const newTeacher = {
                            id: Math.max(...teachers.map(t => t.id)) + 1,
                            name: name,
                            subject: subject,
                            code: code
                        };
                        teachers.push(newTeacher);
                        
                        // Add to users array
                        const newUser = {
                            code: code,
                            role: 'teacher',
                            name: name,
                            subject: subject
                        };
                        users.push(newUser);
                        
                        showNotification('Guru berhasil ditambahkan!', 'success');
                    }
                    
                    closeTeacherModal();
                    showTeacherManagement();
                }
                
                // User Form Handler
                if (e.target.id === 'userForm') {
                    e.preventDefault();
                    
                    const code = document.getElementById('userCodeInput').value;
                    const name = document.getElementById('userName').value;
                    const role = document.getElementById('userRole').value;
                    const subject = document.getElementById('userSubject').value;
                    const userClass = document.getElementById('userClass').value;
                    
                    // Validate code uniqueness (except when editing)
                    const existingUser = users.find(u => u.code === code && u.code !== editingUserCode);
                    if (existingUser) {
                        showNotification('Kode user sudah digunakan!', 'error');
                        return;
                    }
                    
                    if (editingUserCode) {
                        // Edit existing user
                        const user = users.find(u => u.code === editingUserCode);
                        user.code = code;
                        user.name = name;
                        user.role = role;
                        
                        // Update conditional fields
                        delete user.subject;
                        delete user.class;
                        
                        if (role === 'teacher' && subject) {
                            user.subject = subject;
                        } else if (role === 'homeroom' && userClass) {
                            user.class = userClass;
                        }
                        
                        showNotification('Data user berhasil diperbarui!', 'success');
                    } else {
                        // Add new user
                        const newUser = {
                            code: code,
                            role: role,
                            name: name
                        };
                        
                        // Add conditional fields
                        if (role === 'teacher' && subject) {
                            newUser.subject = subject;
                        } else if (role === 'homeroom' && userClass) {
                            newUser.class = userClass;
                        }
                        
                        users.push(newUser);
                        
                        showNotification('User berhasil ditambahkan!', 'success');
                    }
                    
                    closeUserModal();
                    showUserManagement();
                }
            });
        });

        function editLocation(studentId, date, subject) {
            const newLat = prompt('Masukkan Latitude baru:');
            const newLng = prompt('Masukkan Longitude baru:');
            
            if (newLat && newLng) {
                const attendance = attendanceData.find(a => 
                    a.studentId == studentId && a.date === date && a.subject === subject
                );
                if (attendance) {
                    attendance.location = {
                        latitude: parseFloat(newLat),
                        longitude: parseFloat(newLng),
                        timestamp: new Date().toISOString()
                    };
                    showNotification('Lokasi berhasil diperbarui!', 'success');
                    showAttendanceReport(); // Refresh
                }
            }
        }

        function editAttendance(studentId, date, subject) {
            const newStatus = prompt('Masukkan status baru (hadir/sakit/izin/alpha):');
            if (newStatus && ['hadir', 'sakit', 'izin', 'alpha'].includes(newStatus)) {
                const attendance = attendanceData.find(a => 
                    a.studentId == studentId && a.date === date && a.subject === subject
                );
                if (attendance) {
                    attendance.status = newStatus;
                    showNotification('Status absensi berhasil diperbarui!', 'success');
                    showAttendanceReport(); // Refresh
                }
            }
        }

        function deleteAttendance(studentId, date, subject) {
            if (confirm('Apakah Anda yakin ingin menghapus data absensi ini?')) {
                attendanceData = attendanceData.filter(a => 
                    !(a.studentId == studentId && a.date === date && a.subject === subject)
                );
                showNotification('Data absensi berhasil dihapus!', 'success');
                showAttendanceReport(); // Refresh
            }
        }

        function filterHistory() {
            const name = document.getElementById('historyName').value.toLowerCase();
            const className = document.getElementById('historyClass').value;
            const nisn = document.getElementById('historyNISN').value;
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;
            
            let filteredData = attendanceData.filter(a => a.teacherCode === currentUser.code);
            
            if (name) {
                filteredData = filteredData.filter(a => {
                    const student = students.find(s => s.id === a.studentId);
                    return student.name.toLowerCase().includes(name);
                });
            }
            
            if (className) {
                filteredData = filteredData.filter(a => {
                    const student = students.find(s => s.id === a.studentId);
                    return student.class === className;
                });
            }
            
            if (nisn) {
                filteredData = filteredData.filter(a => {
                    const student = students.find(s => s.id === a.studentId);
                    return student.nisn === nisn;
                });
            }
            
            if (startDate) {
                filteredData = filteredData.filter(a => a.date >= startDate);
            }
            
            if (endDate) {
                filteredData = filteredData.filter(a => a.date <= endDate);
            }
            
            // Update table with filtered data
            const tableBody = document.getElementById('historyTableBody');
            tableBody.innerHTML = filteredData.map(attendance => {
                const student = students.find(s => s.id === attendance.studentId);
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.class}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(attendance.status)}">
                                ${attendance.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${attendance.material || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function downloadExcel() {
            const ws = XLSX.utils.json_to_sheet(attendanceData.map(a => {
                const student = students.find(s => s.id === a.studentId);
                return {
                    Tanggal: a.date,
                    Siswa: student.name,
                    NISN: student.nisn,
                    Kelas: student.class,
                    'Mata Pelajaran': a.subject,
                    Status: a.status,
                    Materi: a.material || '',
                    Lokasi: a.location ? `${a.location.latitude}, ${a.location.longitude}` : ''
                };
            }));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Absensi');
            XLSX.writeFile(wb, `Laporan_Absensi_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('File Excel berhasil didownload!', 'success');
        }

        // Additional utility functions
        function getStudentCategoriesForClass(className) {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const thirtyDaysAgoString = thirtyDaysAgo.toISOString().split('T')[0];
            
            const classStudents = students.filter(s => s.class === className);
            const studentsWithAlpha = classStudents.map(student => {
                const alphaCount = attendanceData.filter(a => 
                    a.studentId === student.id && 
                    a.status === 'alpha' && 
                    a.date >= thirtyDaysAgoString
                ).length;
                return { ...student, alphaCount };
            });
            
            return [
                {
                    key: 'sangat-bermasalah',
                    name: 'Sangat Bermasalah',
                    description: 'Alpha 7+ kali (30 hari terakhir)',
                    count: studentsWithAlpha.filter(s => s.alphaCount >= 7).length,
                    color: 'bg-red-100 border-red-200'
                },
                {
                    key: 'perlu-perhatian',
                    name: 'Perlu Perhatian',
                    description: 'Alpha 3-6 kali (30 hari terakhir)',
                    count: studentsWithAlpha.filter(s => s.alphaCount >= 3 && s.alphaCount < 7).length,
                    color: 'bg-yellow-100 border-yellow-200'
                },
                {
                    key: 'mulai-bermasalah',
                    name: 'Mulai Bermasalah',
                    description: 'Alpha 1-2 kali (30 hari terakhir)',
                    count: studentsWithAlpha.filter(s => s.alphaCount >= 1 && s.alphaCount < 3).length,
                    color: 'bg-orange-100 border-orange-200'
                },
                {
                    key: 'normal',
                    name: 'Normal',
                    description: 'Tidak ada alpha (30 hari terakhir)',
                    count: studentsWithAlpha.filter(s => s.alphaCount === 0).length,
                    color: 'bg-green-100 border-green-200'
                }
            ];
        }

        function generateDetailedMonitoringData(className) {
            const classStudents = students.filter(s => s.class === className);
            const classAttendance = attendanceData.filter(a => {
                const student = students.find(s => s.id === a.studentId);
                return student && student.class === className;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return classAttendance.map(attendance => {
                const student = students.find(s => s.id === attendance.studentId);
                const teacher = users.find(u => u.code === attendance.teacherCode);
                
                return `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${attendance.date}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${student.name}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${student.nisn}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${attendance.subject}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 max-w-xs truncate" title="${attendance.material || '-'}">${attendance.material || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(attendance.status)}">
                                ${attendance.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${teacher ? teacher.name : 'Unknown'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            ${attendance.status === 'alpha' ? `
                                <button onclick="sendNotification(${student.id})" class="text-green-600 hover:text-green-900 text-xs">
                                    📱 Kirim WA
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateDetailedMonitoringData(startDate, endDate, subject) {
            const classStudents = students.filter(s => s.class === currentUser.class);
            let filteredData = attendanceData.filter(a => {
                const student = students.find(s => s.id === a.studentId);
                return student && student.class === currentUser.class;
            });
            
            if (startDate) {
                filteredData = filteredData.filter(a => a.date >= startDate);
            }
            
            if (endDate) {
                filteredData = filteredData.filter(a => a.date <= endDate);
            }
            
            if (subject) {
                filteredData = filteredData.filter(a => a.subject === subject);
            }
            
            // Sort by date descending
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Update table
            const tableBody = document.getElementById('monitoringTableBody');
            if (tableBody) {
                tableBody.innerHTML = filteredData.map(attendance => {
                    const student = students.find(s => s.id === attendance.studentId);
                    const teacher = users.find(u => u.code === attendance.teacherCode);
                    
                    return `
                        <tr>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${attendance.date}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${student.name}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${student.nisn}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${attendance.subject}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 max-w-xs truncate" title="${attendance.material || '-'}">${attendance.material || '-'}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(attendance.status)}">
                                    ${attendance.status.toUpperCase()}
                                </span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${teacher ? teacher.name : 'Unknown'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                ${attendance.status === 'alpha' ? `
                                    <button onclick="sendNotification(${student.id})" class="text-green-600 hover:text-green-900 text-xs">
                                        📱 Kirim WA
                                    </button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Update statistics
            updateAttendanceStatistics(filteredData);
        }

        function updateAttendanceStatistics(data = null) {
            const classStudents = students.filter(s => s.class === currentUser.class);
            const attendanceToAnalyze = data || attendanceData.filter(a => {
                const student = students.find(s => s.id === a.studentId);
                return student && student.class === currentUser.class;
            });
            
            const stats = {
                total: attendanceToAnalyze.length,
                hadir: attendanceToAnalyze.filter(a => a.status === 'hadir').length,
                sakit: attendanceToAnalyze.filter(a => a.status === 'sakit').length,
                izin: attendanceToAnalyze.filter(a => a.status === 'izin').length,
                alpha: attendanceToAnalyze.filter(a => a.status === 'alpha').length
            };
            
            // Update DOM elements
            const totalRecords = document.getElementById('totalRecords');
            const totalHadir = document.getElementById('totalHadir');
            const totalSakit = document.getElementById('totalSakit');
            const totalIzin = document.getElementById('totalIzin');
            const totalAlpha = document.getElementById('totalAlpha');
            
            if (totalRecords) totalRecords.textContent = stats.total;
            if (totalHadir) totalHadir.textContent = stats.hadir;
            if (totalSakit) totalSakit.textContent = stats.sakit;
            if (totalIzin) totalIzin.textContent = stats.izin;
            if (totalAlpha) totalAlpha.textContent = stats.alpha;
        }

        function downloadClassExcel() {
            const classStudents = students.filter(s => s.class === currentUser.class);
            const classAttendance = attendanceData.filter(a => {
                const student = students.find(s => s.id === a.studentId);
                return student && student.class === currentUser.class;
            });
            
            // Prepare data for Excel
            const excelData = classAttendance.map(a => {
                const student = students.find(s => s.id === a.studentId);
                const teacher = users.find(u => u.code === a.teacherCode);
                return {
                    'Tanggal': a.date,
                    'Nama Siswa': student.name,
                    'NISN': student.nisn,
                    'Kelas': student.class,
                    'Mata Pelajaran': a.subject,
                    'Materi': a.material || '',
                    'Status Kehadiran': a.status.toUpperCase(),
                    'Guru Pengajar': teacher ? teacher.name : 'Unknown',
                    'Kode Guru': a.teacherCode || '',
                    'Lokasi': a.location ? `${a.location.latitude}, ${a.location.longitude}` : '',
                    'Waktu Input': a.timestamp || ''
                };
            });
            
            // Create summary sheet
            const summaryData = classStudents.map(student => {
                const studentAttendance = classAttendance.filter(a => a.studentId === student.id);
                return {
                    'Nama Siswa': student.name,
                    'NISN': student.nisn,
                    'Kelas': student.class,
                    'No. WA Ortu': student.parentPhone,
                    'Total Hadir': studentAttendance.filter(a => a.status === 'hadir').length,
                    'Total Sakit': studentAttendance.filter(a => a.status === 'sakit').length,
                    'Total Izin': studentAttendance.filter(a => a.status === 'izin').length,
                    'Total Alpha': studentAttendance.filter(a => a.status === 'alpha').length,
                    'Total Kehadiran': studentAttendance.length,
                    'Persentase Hadir': studentAttendance.length > 0 ? 
                        Math.round((studentAttendance.filter(a => a.status === 'hadir').length / studentAttendance.length) * 100) + '%' : '0%'
                };
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Add detailed attendance sheet
            const ws1 = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Detail Absensi');
            
            // Add summary sheet
            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Ringkasan Siswa');
            
            // Download file
            const fileName = `Absensi_Kelas_${currentUser.class}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification(`File Excel "${fileName}" berhasil didownload!`, 'success');
        }

        function downloadClassPDF() {
            // Create a simple PDF content using HTML and print
            const classStudents = students.filter(s => s.class === currentUser.class);
            const classAttendance = attendanceData.filter(a => {
                const student = students.find(s => s.id === a.studentId);
                return student && student.class === currentUser.class;
            });
            
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Absensi Kelas ${currentUser.class}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .status-hadir { background-color: #d4edda; }
                        .status-sakit { background-color: #fff3cd; }
                        .status-izin { background-color: #d1ecf1; }
                        .status-alpha { background-color: #f8d7da; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>LAPORAN ABSENSI SISWA</h1>
                        <h2>Kelas ${currentUser.class}</h2>
                        <p>Wali Kelas: ${currentUser.name}</p>
                        <p>Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}</p>
                    </div>
                    
                    <div class="summary">
                        <h3>Ringkasan Kehadiran</h3>
                        <table>
                            <tr>
                                <th>Total Siswa</th>
                                <th>Total Hadir</th>
                                <th>Total Sakit</th>
                                <th>Total Izin</th>
                                <th>Total Alpha</th>
                            </tr>
                            <tr>
                                <td>${classStudents.length}</td>
                                <td>${classAttendance.filter(a => a.status === 'hadir').length}</td>
                                <td>${classAttendance.filter(a => a.status === 'sakit').length}</td>
                                <td>${classAttendance.filter(a => a.status === 'izin').length}</td>
                                <td>${classAttendance.filter(a => a.status === 'alpha').length}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <h3>Detail Absensi</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Nama Siswa</th>
                                <th>NISN</th>
                                <th>Mata Pelajaran</th>
                                <th>Status</th>
                                <th>Guru</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${classAttendance.sort((a, b) => new Date(b.date) - new Date(a.date)).map(attendance => {
                                const student = students.find(s => s.id === attendance.studentId);
                                const teacher = users.find(u => u.code === attendance.teacherCode);
                                return `
                                    <tr class="status-${attendance.status}">
                                        <td>${attendance.date}</td>
                                        <td>${student.name}</td>
                                        <td>${student.nisn}</td>
                                        <td>${attendance.subject}</td>
                                        <td>${attendance.status.toUpperCase()}</td>
                                        <td>${teacher ? teacher.name : 'Unknown'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                showNotification('Dokumen PDF siap untuk dicetak atau disimpan!', 'success');
            }, 500);
        }

        function generateMonitoringDataForClass(className) {
            const classStudents = students.filter(s => s.class === className);
            
            return classStudents.map(student => {
                const studentAttendance = attendanceData.filter(a => a.studentId === student.id);
                const hadir = studentAttendance.filter(a => a.status === 'hadir').length;
                const sakit = studentAttendance.filter(a => a.status === 'sakit').length;
                const izin = studentAttendance.filter(a => a.status === 'izin').length;
                const alpha = studentAttendance.filter(a => a.status === 'alpha').length;
                
                const status = alpha >= 3 ? 'Perlu Perhatian' : 'Normal';
                const statusColor = alpha >= 3 ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${student.name}</div>
                                <div class="text-sm text-gray-500">NISN: ${student.nisn}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${hadir}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sakit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${izin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${alpha}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            ${alpha >= 3 ? `<button onclick="sendWhatsAppNotification('${student.parentPhone}', '${student.name}', ${alpha})" class="text-green-600 hover:text-green-900">Kirim WA</button>` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function generateMonitoringData() {
            return students.map(student => {
                const studentAttendance = attendanceData.filter(a => a.studentId === student.id);
                const hadir = studentAttendance.filter(a => a.status === 'hadir').length;
                const sakit = studentAttendance.filter(a => a.status === 'sakit').length;
                const izin = studentAttendance.filter(a => a.status === 'izin').length;
                const alpha = studentAttendance.filter(a => a.status === 'alpha').length;
                
                const status = alpha >= 3 ? 'Perlu Perhatian' : 'Normal';
                const statusColor = alpha >= 3 ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${student.name}</div>
                                <div class="text-sm text-gray-500">NISN: ${student.nisn}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${hadir}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sakit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${izin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${alpha}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function generateDailyAttendanceData(className) {
            const classStudents = students.filter(s => s.class === className);
            
            // Get unique dates from attendance data
            const uniqueDates = [...new Set(attendanceData.map(a => a.date))].sort((a, b) => new Date(b) - new Date(a));
            
            const dailyData = [];
            
            uniqueDates.forEach(date => {
                classStudents.forEach(student => {
                    // Get first subject attendance for this student on this date (earliest timestamp)
                    const studentDayAttendance = attendanceData
                        .filter(a => a.studentId === student.id && a.date === date)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    if (studentDayAttendance.length > 0) {
                        const firstAttendance = studentDayAttendance[0];
                        const teacher = users.find(u => u.code === firstAttendance.teacherCode);
                        
                        dailyData.push({
                            date: date,
                            student: student,
                            status: firstAttendance.status,
                            subject: firstAttendance.subject,
                            teacher: teacher ? teacher.name : 'Unknown',
                            teacherCode: firstAttendance.teacherCode
                        });
                    }
                });
            });
            
            return dailyData.map(data => `
                <tr>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${data.date}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${data.student.name}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${data.student.nisn}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(data.status)}">
                            ${data.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                        ${data.status === 'alpha' ? `
                            <button onclick="sendNotification(${data.student.id})" class="text-green-600 hover:text-green-900 text-xs">
                                📱 Kirim WA
                            </button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function updateDailyAttendanceData(startDate, endDate) {
            const classStudents = students.filter(s => s.class === currentUser.class);
            
            // Get unique dates from attendance data with filtering
            let uniqueDates = [...new Set(attendanceData.map(a => a.date))];
            
            if (startDate) {
                uniqueDates = uniqueDates.filter(date => date >= startDate);
            }
            
            if (endDate) {
                uniqueDates = uniqueDates.filter(date => date <= endDate);
            }
            
            uniqueDates.sort((a, b) => new Date(b) - new Date(a));
            
            const dailyData = [];
            
            uniqueDates.forEach(date => {
                classStudents.forEach(student => {
                    // Get first subject attendance for this student on this date (earliest timestamp)
                    const studentDayAttendance = attendanceData
                        .filter(a => a.studentId === student.id && a.date === date)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    if (studentDayAttendance.length > 0) {
                        const firstAttendance = studentDayAttendance[0];
                        const teacher = users.find(u => u.code === firstAttendance.teacherCode);
                        
                        dailyData.push({
                            date: date,
                            student: student,
                            status: firstAttendance.status,
                            subject: firstAttendance.subject,
                            teacher: teacher ? teacher.name : 'Unknown',
                            teacherCode: firstAttendance.teacherCode
                        });
                    }
                });
            });
            
            // Update table
            const tableBody = document.getElementById('dailyAttendanceTableBody');
            if (tableBody) {
                tableBody.innerHTML = dailyData.map(data => `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${data.date}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${data.student.name}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${data.student.nisn}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(data.status)}">
                                ${data.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            ${data.status === 'alpha' ? `
                                <button onclick="sendNotification(${data.student.id})" class="text-green-600 hover:text-green-900 text-xs">
                                    📱 Kirim WA
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update statistics
            updateDailyAttendanceStatistics(dailyData);
        }

        function updateDailyAttendanceStatistics(data = null) {
            const classStudents = students.filter(s => s.class === currentUser.class);
            
            let dailyData = data;
            if (!dailyData) {
                // Generate daily data if not provided
                const uniqueDates = [...new Set(attendanceData.map(a => a.date))];
                dailyData = [];
                
                uniqueDates.forEach(date => {
                    classStudents.forEach(student => {
                        const studentDayAttendance = attendanceData
                            .filter(a => a.studentId === student.id && a.date === date)
                            .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        
                        if (studentDayAttendance.length > 0) {
                            const firstAttendance = studentDayAttendance[0];
                            dailyData.push({
                                date: date,
                                student: student,
                                status: firstAttendance.status
                            });
                        }
                    });
                });
            }
            
            const stats = {
                totalDays: [...new Set(dailyData.map(d => d.date))].length,
                hadir: dailyData.filter(d => d.status === 'hadir').length,
                sakit: dailyData.filter(d => d.status === 'sakit').length,
                izin: dailyData.filter(d => d.status === 'izin').length,
                alpha: dailyData.filter(d => d.status === 'alpha').length
            };
            
            // Update DOM elements
            const dailyTotalDays = document.getElementById('dailyTotalDays');
            const dailyTotalHadir = document.getElementById('dailyTotalHadir');
            const dailyTotalSakit = document.getElementById('dailyTotalSakit');
            const dailyTotalIzin = document.getElementById('dailyTotalIzin');
            const dailyTotalAlpha = document.getElementById('dailyTotalAlpha');
            
            if (dailyTotalDays) dailyTotalDays.textContent = stats.totalDays;
            if (dailyTotalHadir) dailyTotalHadir.textContent = stats.hadir;
            if (dailyTotalSakit) dailyTotalSakit.textContent = stats.sakit;
            if (dailyTotalIzin) dailyTotalIzin.textContent = stats.izin;
            if (dailyTotalAlpha) dailyTotalAlpha.textContent = stats.alpha;
        }

        function downloadDailyExcel() {
            const classStudents = students.filter(s => s.class === currentUser.class);
            
            // Generate daily attendance data
            const uniqueDates = [...new Set(attendanceData.map(a => a.date))].sort((a, b) => new Date(b) - new Date(a));
            const dailyData = [];
            
            uniqueDates.forEach(date => {
                classStudents.forEach(student => {
                    const studentDayAttendance = attendanceData
                        .filter(a => a.studentId === student.id && a.date === date)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    if (studentDayAttendance.length > 0) {
                        const firstAttendance = studentDayAttendance[0];
                        const teacher = users.find(u => u.code === firstAttendance.teacherCode);
                        
                        dailyData.push({
                            'Tanggal': date,
                            'Nama Siswa': student.name,
                            'NISN': student.nisn,
                            'Kelas': student.class,
                            'Status Harian': firstAttendance.status.toUpperCase(),
                            'Mata Pelajaran Pertama': firstAttendance.subject,
                            'Guru Pengajar': teacher ? teacher.name : 'Unknown',
                            'Kode Guru': firstAttendance.teacherCode || '',
                            'No. WA Ortu': student.parentPhone,
                            'Waktu Input': firstAttendance.timestamp || ''
                        });
                    }
                });
            });
            
            // Create summary by student
            const summaryData = classStudents.map(student => {
                const studentDailyData = dailyData.filter(d => d['Nama Siswa'] === student.name);
                return {
                    'Nama Siswa': student.name,
                    'NISN': student.nisn,
                    'Kelas': student.class,
                    'No. WA Ortu': student.parentPhone,
                    'Total Hari Hadir': studentDailyData.filter(d => d['Status Harian'] === 'HADIR').length,
                    'Total Hari Sakit': studentDailyData.filter(d => d['Status Harian'] === 'SAKIT').length,
                    'Total Hari Izin': studentDailyData.filter(d => d['Status Harian'] === 'IZIN').length,
                    'Total Hari Alpha': studentDailyData.filter(d => d['Status Harian'] === 'ALPHA').length,
                    'Total Hari Masuk': studentDailyData.length,
                    'Persentase Kehadiran': studentDailyData.length > 0 ? 
                        Math.round((studentDailyData.filter(d => d['Status Harian'] === 'HADIR').length / studentDailyData.length) * 100) + '%' : '0%'
                };
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Add daily attendance sheet
            const ws1 = XLSX.utils.json_to_sheet(dailyData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Absensi Harian');
            
            // Add summary sheet
            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Ringkasan Harian');
            
            // Download file
            const fileName = `Absensi_Harian_Kelas_${currentUser.class}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification(`File Excel harian "${fileName}" berhasil didownload!`, 'success');
        }

        function downloadDailyPDF() {
            const classStudents = students.filter(s => s.class === currentUser.class);
            
            // Generate daily attendance data
            const uniqueDates = [...new Set(attendanceData.map(a => a.date))].sort((a, b) => new Date(b) - new Date(a));
            const dailyData = [];
            
            uniqueDates.forEach(date => {
                classStudents.forEach(student => {
                    const studentDayAttendance = attendanceData
                        .filter(a => a.studentId === student.id && a.date === date)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    if (studentDayAttendance.length > 0) {
                        const firstAttendance = studentDayAttendance[0];
                        const teacher = users.find(u => u.code === firstAttendance.teacherCode);
                        
                        dailyData.push({
                            date: date,
                            student: student,
                            status: firstAttendance.status,
                            subject: firstAttendance.subject,
                            teacher: teacher ? teacher.name : 'Unknown'
                        });
                    }
                });
            });
            
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Absensi Harian Kelas ${currentUser.class}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .status-hadir { background-color: #d4edda; }
                        .status-sakit { background-color: #fff3cd; }
                        .status-izin { background-color: #d1ecf1; }
                        .status-alpha { background-color: #f8d7da; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>LAPORAN ABSENSI HARIAN SISWA</h1>
                        <h2>Kelas ${currentUser.class}</h2>
                        <p>Wali Kelas: ${currentUser.name}</p>
                        <p>Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}</p>
                        <p><em>Data diambil dari mata pelajaran pertama setiap hari</em></p>
                    </div>
                    
                    <div class="summary">
                        <h3>Ringkasan Kehadiran Harian</h3>
                        <table>
                            <tr>
                                <th>Total Hari</th>
                                <th>Total Hadir</th>
                                <th>Total Sakit</th>
                                <th>Total Izin</th>
                                <th>Total Alpha</th>
                            </tr>
                            <tr>
                                <td>${[...new Set(dailyData.map(d => d.date))].length}</td>
                                <td>${dailyData.filter(d => d.status === 'hadir').length}</td>
                                <td>${dailyData.filter(d => d.status === 'sakit').length}</td>
                                <td>${dailyData.filter(d => d.status === 'izin').length}</td>
                                <td>${dailyData.filter(d => d.status === 'alpha').length}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <h3>Detail Absensi Harian</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Nama Siswa</th>
                                <th>NISN</th>
                                <th>Status Harian</th>
                                <th>Mata Pelajaran Pertama</th>
                                <th>Guru</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dailyData.map(data => `
                                <tr class="status-${data.status}">
                                    <td>${data.date}</td>
                                    <td>${data.student.name}</td>
                                    <td>${data.student.nisn}</td>
                                    <td>${data.status.toUpperCase()}</td>
                                    <td>${data.subject}</td>
                                    <td>${data.teacher}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                showNotification('Dokumen PDF absensi harian siap untuk dicetak atau disimpan!', 'success');
            }, 500);
        }

        function updateMonitoringData(startDate, endDate) {
            let filteredData = attendanceData;
            
            if (startDate) {
                filteredData = filteredData.filter(a => a.date >= startDate);
            }
            
            if (endDate) {
                filteredData = filteredData.filter(a => a.date <= endDate);
            }
            
            // Update the monitoring table with filtered data
            const tableBody = document.getElementById('monitoringTableBody');
            if (tableBody) {
                const relevantStudents = currentUser.role === 'homeroom' ? 
                    students.filter(s => s.class === currentUser.class) : 
                    students;
                
                tableBody.innerHTML = relevantStudents.map(student => {
                    const studentAttendance = filteredData.filter(a => a.studentId === student.id);
                    const hadir = studentAttendance.filter(a => a.status === 'hadir').length;
                    const sakit = studentAttendance.filter(a => a.status === 'sakit').length;
                    const izin = studentAttendance.filter(a => a.status === 'izin').length;
                    const alpha = studentAttendance.filter(a => a.status === 'alpha').length;
                    
                    const status = alpha >= 3 ? 'Perlu Perhatian' : 'Normal';
                    const statusColor = alpha >= 3 ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100';
                    
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${student.name}</div>
                                    <div class="text-sm text-gray-500">NISN: ${student.nisn}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${hadir}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sakit}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${izin}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${alpha}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                    ${status}
                                </span>
                            </td>
                            ${currentUser.role === 'homeroom' ? `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    ${alpha >= 3 ? `<button onclick="sendWhatsAppNotification('${student.parentPhone}', '${student.name}', ${alpha})" class="text-green-600 hover:text-green-900">Kirim WA</button>` : '-'}
                                </td>
                            ` : ''}
                        </tr>
                    `;
                }).join('');
            }
        }

        function generateMonitoringData() {
            return students.map(student => {
                const studentAttendance = attendanceData.filter(a => a.studentId === student.id);
                const hadir = studentAttendance.filter(a => a.status === 'hadir').length;
                const sakit = studentAttendance.filter(a => a.status === 'sakit').length;
                const izin = studentAttendance.filter(a => a.status === 'izin').length;
                const alpha = studentAttendance.filter(a => a.status === 'alpha').length;
                
                const status = alpha >= 3 ? 'Perlu Perhatian' : 'Normal';
                const statusColor = alpha >= 3 ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${student.name}</div>
                                <div class="text-sm text-gray-500">NISN: ${student.nisn}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${hadir}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sakit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${izin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${alpha}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function generateDailyAttendanceData(className) {
            const classStudents = students.filter(s => s.class === className);
            
            // Get unique dates from attendance data
            const uniqueDates = [...new Set(attendanceData.map(a => a.date))].sort((a, b) => new Date(b) - new Date(a));
            
            const dailyData = [];
            
            uniqueDates.forEach(date => {
                classStudents.forEach(student => {
                    // Get first subject attendance for this student on this date (earliest timestamp)
                    const studentDayAttendance = attendanceData
                        .filter(a => a.studentId === student.id && a.date === date)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    if (studentDayAttendance.length > 0) {
                        const firstAttendance = studentDayAttendance[0];
                        const teacher = users.find(u => u.code === firstAttendance.teacherCode);
                        
                        dailyData.push({
                            date: date,
                            student: student,
                            status: firstAttendance.status,
                            subject: firstAttendance.subject,
                            teacher: teacher ? teacher.name : 'Unknown',
                            teacherCode: firstAttendance.teacherCode
                        });
                    }
                });
            });
            
            return dailyData.map(data => `
                <tr>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${data.date}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${data.student.name}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${data.student.nisn}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(data.status)}">
                            ${data.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                        ${data.status === 'alpha' ? `
                            <button onclick="sendNotification(${data.student.id})" class="text-green-600 hover:text-green-900 text-xs">
                                📱 Kirim WA
                            </button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function updateDailyAttendanceData(startDate, endDate) {
            const classStudents = students.filter(s => s.class === currentUser.class);
            
            // Get unique dates from attendance data with filtering
            let uniqueDates = [...new Set(attendanceData.map(a => a.date))];
            
            if (startDate) {
                uniqueDates = uniqueDates.filter(date => date >= startDate);
            }
            
            if (endDate) {
                uniqueDates = uniqueDates.filter(date => date <= endDate);
            }
            
            uniqueDates.sort((a, b) => new Date(b) - new Date(a));
            
            const dailyData = [];
            
            uniqueDates.forEach(date => {
                classStudents.forEach(student => {
                    // Get first subject attendance for this student on this date (earliest timestamp)
                    const studentDayAttendance = attendanceData
                        .filter(a => a.studentId === student.id && a.date === date)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    if (studentDayAttendance.length > 0) {
                        const firstAttendance = studentDayAttendance[0];
                        const teacher = users.find(u => u.code === firstAttendance.teacherCode);
                        
                        dailyData.push({
                            date: date,
                            student: student,
                            status: firstAttendance.status,
                            subject: firstAttendance.subject,
                            teacher: teacher ? teacher.name : 'Unknown',
                            teacherCode: firstAttendance.teacherCode
                        });
                    }
                });
            });
            
            // Update table
            const tableBody = document.getElementById('dailyAttendanceTableBody');
            if (tableBody) {
                tableBody.innerHTML = dailyData.map(data => `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${data.date}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${data.student.name}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${data.student.nisn}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(data.status)}">
                                ${data.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            ${data.status === 'alpha' ? `
                                <button onclick="sendNotification(${data.student.id})" class="text-green-600 hover:text-green-900 text-xs">
                                    📱 Kirim WA
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update statistics
            updateDailyAttendanceStatistics(dailyData);
        }

        function updateDailyAttendanceStatistics(data = null) {
            const classStudents = students.filter(s => s.class === currentUser.class);
            
            let dailyData = data;
            if (!dailyData) {
                // Generate daily data if not provided
                const uniqueDates = [...new Set(attendanceData.map(a => a.date))];
                dailyData = [];
                
                uniqueDates.forEach(date => {
                    classStudents.forEach(student => {
                        const studentDayAttendance = attendanceData
                            .filter(a => a.studentId === student.id && a.date === date)
                            .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        
                        if (studentDayAttendance.length > 0) {
                            const firstAttendance = studentDayAttendance[0];
                            dailyData.push({
                                date: date,
                                student: student,
                                status: firstAttendance.status
                            });
                        }
                    });
                });
            }
            
            const stats = {
                totalDays: [...new Set(dailyData.map(d => d.date))].length,
                hadir: dailyData.filter(d => d.status === 'hadir').length,
                sakit: dailyData.filter(d => d.status === 'sakit').length,
                izin: dailyData.filter(d => d.status === 'izin').length,
                alpha: dailyData.filter(d => d.status === 'alpha').length
            };
            
            // Update DOM elements
            const dailyTotalDays = document.getElementById('dailyTotalDays');
            const dailyTotalHadir = document.getElementById('dailyTotalHadir');
            const dailyTotalSakit = document.getElementById('dailyTotalSakit');
            const dailyTotalIzin = document.getElementById('dailyTotalIzin');
            const dailyTotalAlpha = document.getElementById('dailyTotalAlpha');
            
            if (dailyTotalDays) dailyTotalDays.textContent = stats.totalDays;
            if (dailyTotalHadir) dailyTotalHadir.textContent = stats.hadir;
            if (dailyTotalSakit) dailyTotalSakit.textContent = stats.sakit;
            if (dailyTotalIzin) dailyTotalIzin.textContent = stats.izin;
            if (dailyTotalAlpha) dailyTotalAlpha.textContent = stats.alpha;
        }

        function downloadDailyExcel() {
            const classStudents = students.filter(s => s.class === currentUser.class);
            
            // Generate daily attendance data
            const uniqueDates = [...new Set(attendanceData.map(a => a.date))].sort((a, b) => new Date(b) - new Date(a));
            const dailyData = [];
            
            uniqueDates.forEach(date => {
                classStudents.forEach(student => {
                    const studentDayAttendance = attendanceData
                        .filter(a => a.studentId === student.id && a.date === date)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    if (studentDayAttendance.length > 0) {
                        const firstAttendance = studentDayAttendance[0];
                        const teacher = users.find(u => u.code === firstAttendance.teacherCode);
                        
                        dailyData.push({
                            'Tanggal': date,
                            'Nama Siswa': student.name,
                            'NISN': student.nisn,
                            'Kelas': student.class,
                            'Status Harian': firstAttendance.status.toUpperCase(),
                            'Mata Pelajaran Pertama': firstAttendance.subject,
                            'Guru Pengajar': teacher ? teacher.name : 'Unknown',
                            'Kode Guru': firstAttendance.teacherCode || '',
                            'No. WA Ortu': student.parentPhone,
                            'Waktu Input': firstAttendance.timestamp || ''
                        });
                    }
                });
            });
            
            // Create summary by student
            const summaryData = classStudents.map(student => {
                const studentDailyData = dailyData.filter(d => d['Nama Siswa'] === student.name);
                return {
                    'Nama Siswa': student.name,
                    'NISN': student.nisn,
                    'Kelas': student.class,
                    'No. WA Ortu': student.parentPhone,
                    'Total Hari Hadir': studentDailyData.filter(d => d['Status Harian'] === 'HADIR').length,
                    'Total Hari Sakit': studentDailyData.filter(d => d['Status Harian'] === 'SAKIT').length,
                    'Total Hari Izin': studentDailyData.filter(d => d['Status Harian'] === 'IZIN').length,
                    'Total Hari Alpha': studentDailyData.filter(d => d['Status Harian'] === 'ALPHA').length,
                    'Total Hari Masuk': studentDailyData.length,
                    'Persentase Kehadiran': studentDailyData.length > 0 ? 
                        Math.round((studentDailyData.filter(d => d['Status Harian'] === 'HADIR').length / studentDailyData.length) * 100) + '%' : '0%'
                };
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Add daily attendance sheet
            const ws1 = XLSX.utils.json_to_sheet(dailyData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Absensi Harian');
            
            // Add summary sheet
            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Ringkasan Harian');
            
            // Download file
            const fileName = `Absensi_Harian_Kelas_${currentUser.class}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification(`File Excel harian "${fileName}" berhasil didownload!`, 'success');
        }

        function downloadDailyPDF() {
            const classStudents = students.filter(s => s.class === currentUser.class);
            
            // Generate daily attendance data
            const uniqueDates = [...new Set(attendanceData.map(a => a.date))].sort((a, b) => new Date(b) - new Date(a));
            const dailyData = [];
            
            uniqueDates.forEach(date => {
                classStudents.forEach(student => {
                    const studentDayAttendance = attendanceData
                        .filter(a => a.studentId === student.id && a.date === date)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    if (studentDayAttendance.length > 0) {
                        const firstAttendance = studentDayAttendance[0];
                        const teacher = users.find(u => u.code === firstAttendance.teacherCode);
                        
                        dailyData.push({
                            date: date,
                            student: student,
                            status: firstAttendance.status,
                            subject: firstAttendance.subject,
                            teacher: teacher ? teacher.name : 'Unknown'
                        });
                    }
                });
            });
            
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Absensi Harian Kelas ${currentUser.class}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .status-hadir { background-color: #d4edda; }
                        .status-sakit { background-color: #fff3cd; }
                        .status-izin { background-color: #d1ecf1; }
                        .status-alpha { background-color: #f8d7da; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>LAPORAN ABSENSI HARIAN SISWA</h1>
                        <h2>Kelas ${currentUser.class}</h2>
                        <p>Wali Kelas: ${currentUser.name}</p>
                        <p>Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}</p>
                        <p><em>Data diambil dari mata pelajaran pertama setiap hari</em></p>
                    </div>
                    
                    <div class="summary">
                        <h3>Ringkasan Kehadiran Harian</h3>
                        <table>
                            <tr>
                                <th>Total Hari</th>
                                <th>Total Hadir</th>
                                <th>Total Sakit</th>
                                <th>Total Izin</th>
                                <th>Total Alpha</th>
                            </tr>
                            <tr>
                                <td>${[...new Set(dailyData.map(d => d.date))].length}</td>
                                <td>${dailyData.filter(d => d.status === 'hadir').length}</td>
                                <td>${dailyData.filter(d => d.status === 'sakit').length}</td>
                                <td>${dailyData.filter(d => d.status === 'izin').length}</td>
                                <td>${dailyData.filter(d => d.status === 'alpha').length}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <h3>Detail Absensi Harian</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Nama Siswa</th>
                                <th>NISN</th>
                                <th>Status Harian</th>
                                <th>Mata Pelajaran Pertama</th>
                                <th>Guru</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dailyData.map(data => `
                                <tr class="status-${data.status}">
                                    <td>${data.date}</td>
                                    <td>${data.student.name}</td>
                                    <td>${data.student.nisn}</td>
                                    <td>${data.status.toUpperCase()}</td>
                                    <td>${data.subject}</td>
                                    <td>${data.teacher}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                showNotification('Dokumen PDF absensi harian siap untuk dicetak atau disimpan!', 'success');
            }, 500);
        }

        function getStatusColor(status) {
            switch(status) {
                case 'hadir': return 'bg-green-100 text-green-800';
                case 'sakit': return 'bg-yellow-100 text-yellow-800';
                case 'izin': return 'bg-blue-100 text-blue-800';
                case 'alpha': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function checkStudentsNeedingAttention() {
            const studentsNeedingAttention = getStudentsNeedingAttention();
            if (studentsNeedingAttention.length > 0) {
                showNotification(`${studentsNeedingAttention.length} siswa memerlukan perhatian khusus!`, 'warning');
            }
        }

        // Notification history storage
        let notificationHistory = [];

        function selectStudentForNotification(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                const selectElement = document.getElementById('selectedStudent');
                selectElement.value = studentId;
                updateParentContact();
                showNotification(`Siswa ${student.name} dipilih untuk notifikasi`, 'success');
            }
        }

        function updateParentContact() {
            const selectElement = document.getElementById('selectedStudent');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const parentContactInput = document.getElementById('parentContact');
            
            if (selectedOption.value) {
                const phone = selectedOption.getAttribute('data-phone');
                parentContactInput.value = phone;
                parentContactInput.classList.remove('bg-gray-100');
                parentContactInput.classList.add('bg-green-50');
            } else {
                parentContactInput.value = '';
                parentContactInput.classList.remove('bg-green-50');
                parentContactInput.classList.add('bg-gray-100');
            }
        }

        function sendQuickWhatsAppNotification(phone, studentName, alphaCount, studentClass) {
            const message = encodeURIComponent(`Assalamu'alaikum Wr. Wb.

Yth. Bapak/Ibu Wali Murid,

Kami dari pihak sekolah ingin menginformasikan bahwa putra/putri Anda:

Nama: ${studentName}
Kelas: ${studentClass}

Telah tidak hadir tanpa keterangan (alpha) sebanyak ${alphaCount} kali.

Kami mohon perhatian dan kerja sama Bapak/Ibu untuk memantau kehadiran putra/putri Anda di sekolah.

Terima kasih atas perhatiannya.

Wassalamu'alaikum Wr. Wb.

${currentUser.name}
${currentUser.role === 'principal' ? 'Kepala Sekolah' : currentUser.role === 'homeroom' ? `Wali Kelas ${currentUser.class}` : 'Guru'}`);
            
            const whatsappUrl = `https://wa.me/${phone.replace(/^0/, '62')}?text=${message}`;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
            
            // Add to notification history
            addToNotificationHistory(studentName, phone, 'Pesan Cepat');
            
            showNotification(`Membuka WhatsApp untuk mengirim pesan ke orang tua ${studentName}...`, 'success');
        }

        function sendCustomWhatsAppNotification() {
            const selectElement = document.getElementById('selectedStudent');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const phone = document.getElementById('parentContact').value;
            const template = document.getElementById('messageTemplate').value;
            
            if (!selectedOption.value) {
                showNotification('Pilih siswa terlebih dahulu!', 'error');
                return;
            }
            
            if (!phone) {
                showNotification('Nomor WhatsApp orang tua tidak tersedia!', 'error');
                return;
            }
            
            if (!template.trim()) {
                showNotification('Template pesan tidak boleh kosong!', 'error');
                return;
            }
            
            const studentName = selectedOption.text.split(' (')[0];
            const alphaCount = selectedOption.getAttribute('data-alpha');
            const studentClass = selectedOption.getAttribute('data-class');
            
            // Replace placeholders in template
            const personalizedMessage = template
                .replace(/\[NAMA_SISWA\]/g, studentName)
                .replace(/\[KELAS_SISWA\]/g, studentClass)
                .replace(/\[JUMLAH_ALPHA\]/g, alphaCount)
                .replace(/\[NAMA_PENGIRIM\]/g, currentUser.name);
            
            const encodedMessage = encodeURIComponent(personalizedMessage);
            const whatsappUrl = `https://wa.me/${phone.replace(/^0/, '62')}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
            
            // Add to notification history
            addToNotificationHistory(studentName, phone, 'Pesan Custom');
            
            showNotification(`Membuka WhatsApp untuk mengirim pesan ke orang tua ${studentName}...`, 'success');
        }

        function previewNotificationMessage() {
            const selectElement = document.getElementById('selectedStudent');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const phone = document.getElementById('parentContact').value;
            const template = document.getElementById('messageTemplate').value;
            
            if (!selectedOption.value) {
                showNotification('Pilih siswa terlebih dahulu untuk preview!', 'error');
                return;
            }
            
            const studentName = selectedOption.text.split(' (')[0];
            const alphaCount = selectedOption.getAttribute('data-alpha');
            const studentClass = selectedOption.getAttribute('data-class');
            
            // Replace placeholders in template
            const personalizedMessage = template
                .replace(/\[NAMA_SISWA\]/g, studentName)
                .replace(/\[KELAS_SISWA\]/g, studentClass)
                .replace(/\[JUMLAH_ALPHA\]/g, alphaCount)
                .replace(/\[NAMA_PENGIRIM\]/g, currentUser.name);
            
            document.getElementById('previewContent').textContent = personalizedMessage;
            document.getElementById('previewPhone').textContent = phone;
            document.getElementById('messagePreview').classList.remove('hidden');
        }

        function closePreview() {
            document.getElementById('messagePreview').classList.add('hidden');
        }

        function addToNotificationHistory(studentName, phone, type) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const historyItem = {
                studentName,
                phone,
                type,
                time: timeString,
                sender: currentUser.name
            };
            
            notificationHistory.unshift(historyItem);
            updateNotificationHistoryDisplay();
        }

        function updateNotificationHistoryDisplay() {
            const historyContainer = document.getElementById('notificationHistory');
            if (!historyContainer) return;
            
            if (notificationHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p class="text-sm">Belum ada notifikasi yang dikirim hari ini</p>
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = notificationHistory.map(item => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <p class="text-sm font-medium text-gray-900">
                            📱 ${item.type} ke orang tua ${item.studentName}
                        </p>
                        <p class="text-xs text-gray-600">
                            📞 ${item.phone} • ⏰ ${item.time} • 👤 ${item.sender}
                        </p>
                    </div>
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded">
                        Terkirim
                    </span>
                </div>
            `).join('');
        }

        function sendNotification(studentId) {
            const student = students.find(s => s.id === studentId);
            const alphaCount = attendanceData.filter(a => 
                a.studentId === studentId && a.status === 'alpha'
            ).length;
            
            sendQuickWhatsAppNotification(student.parentPhone, student.name, alphaCount, student.class);
        }

        function previewMessage() {
            const template = document.getElementById('messageTemplate').value;
            const preview = document.getElementById('messagePreview');
            const content = document.getElementById('previewContent');
            
            // Sample data for preview
            const sampleMessage = template
                .replace('[NAMA_SISWA]', 'Ahmad Rizki')
                .replace('[JUMLAH_ALPHA]', '3')
                .replace('[MATA_PELAJARAN]', 'Matematika')
                .replace('[NAMA_WALI_KELAS]', currentUser.name);
            
            content.textContent = sampleMessage;
            preview.classList.remove('hidden');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 
                           type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ADMIN FUNCTIONS
        function showStudentManagement() {
            document.getElementById('pageTitle').textContent = 'Kelola Siswa';
            document.getElementById('pageSubtitle').textContent = 'Tambah, edit, dan hapus data siswa';
            
            const content = `
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Data Siswa</h3>
                        <button onclick="showAddStudentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            Tambah Siswa
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. WA Ortu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${students.map(student => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.nisn}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.class}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.parentPhone}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onclick="editStudent(${student.id})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                                            <button onclick="deleteStudent(${student.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Modal Add/Edit Student -->
                <div id="studentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4">
                        <h3 id="studentModalTitle" class="text-lg font-semibold mb-4">Tambah Siswa</h3>
                        <form id="studentForm" class="space-y-4">
                            <div>
                                <label for="studentNISN" class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                                <input type="text" id="studentNISN" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label for="studentName" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label for="studentClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="studentClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="">Pilih Kelas</option>
                                    <option value="10A">10A</option>
                                    <option value="10B">10B</option>
                                    <option value="11A">11A</option>
                                    <option value="11B">11B</option>
                                    <option value="12A">12A</option>
                                    <option value="12B">12B</option>
                                </select>
                            </div>
                            <div>
                                <label for="parentPhone" class="block text-sm font-medium text-gray-700 mb-2">No. WhatsApp Orang Tua</label>
                                <input type="tel" id="parentPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="08xxxxxxxxxx" required>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="closeStudentModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Initialize filter statistics
            updateFilterStatistics();
        }

        function showTeacherManagement() {
            document.getElementById('pageTitle').textContent = 'Kelola Guru';
            document.getElementById('pageSubtitle').textContent = 'Tambah, edit, dan hapus data guru mata pelajaran';
            
            const content = `
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Data Guru</h3>
                        <button onclick="showAddTeacherModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            Tambah Guru
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${teachers.map(teacher => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.subject}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.code}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onclick="editTeacher(${teacher.id})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                                            <button onclick="deleteTeacher(${teacher.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Modal Add/Edit Teacher -->
                <div id="teacherModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4">
                        <h3 id="teacherModalTitle" class="text-lg font-semibold mb-4">Tambah Guru</h3>
                        <form id="teacherForm" class="space-y-4">
                            <div>
                                <label for="teacherName" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="teacherName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label for="teacherSubject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select id="teacherSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="">Pilih Mata Pelajaran</option>
                                    <option value="Matematika">Matematika</option>
                                    <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                    <option value="Bahasa Inggris">Bahasa Inggris</option>
                                    <option value="Fisika">Fisika</option>
                                    <option value="Kimia">Kimia</option>
                                    <option value="Biologi">Biologi</option>
                                    <option value="Sejarah">Sejarah</option>
                                    <option value="Geografi">Geografi</option>
                                    <option value="Ekonomi">Ekonomi</option>
                                    <option value="Sosiologi">Sosiologi</option>
                                    <option value="PKN">PKN</option>
                                    <option value="Agama">Agama</option>
                                    <option value="Seni Budaya">Seni Budaya</option>
                                    <option value="Penjaskes">Penjaskes</option>
                                </select>
                            </div>
                            <div>
                                <label for="teacherCode" class="block text-sm font-medium text-gray-700 mb-2">Kode User</label>
                                <input type="text" id="teacherCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="GURU001" required>
                                <p class="text-xs text-gray-500 mt-1">Format: GURU001, GURU002, dst.</p>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="closeTeacherModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Initialize filter statistics
            updateFilterStatistics();
        }

        function showUserManagement() {
            document.getElementById('pageTitle').textContent = 'Kelola User';
            document.getElementById('pageSubtitle').textContent = 'Kelola kode akses pengguna sistem (Admin, Guru, Wali Kelas, Kepala Sekolah)';
            
            const content = `
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Kode Akses User</h3>
                        <button onclick="showAddUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            Tambah User
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detail</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${users.map(user => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">${user.code}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRoleColor(user.role)}">
                                                ${getRoleLabel(user.role)}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ${user.subject || user.class || '-'}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onclick="editUser('${user.code}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                                            <button onclick="deleteUser('${user.code}')" class="text-red-600 hover:text-red-900">Hapus</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Modal Add/Edit User -->
                <div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4">
                        <h3 id="userModalTitle" class="text-lg font-semibold mb-4">Tambah User</h3>
                        <form id="userForm" class="space-y-4">
                            <div>
                                <label for="userCode" class="block text-sm font-medium text-gray-700 mb-2">Kode User</label>
                                <input type="text" id="userCodeInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ADMIN001, GURU001, WALI001, KEPSEK001" required>
                                <p class="text-xs text-gray-500 mt-1">Format: ADMIN001, GURU001, WALI001, KEPSEK001</p>
                            </div>
                            <div>
                                <label for="userName" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="userName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label for="userRole" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                <select id="userRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="toggleUserDetails()" required>
                                    <option value="">Pilih Role</option>
                                    <option value="admin">Administrator</option>
                                    <option value="teacher">Guru Mata Pelajaran</option>
                                    <option value="homeroom">Wali Kelas</option>
                                    <option value="principal">Kepala Sekolah</option>
                                </select>
                            </div>
                            <div id="teacherSubjectDiv" class="hidden">
                                <label for="userSubject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select id="userSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Mata Pelajaran</option>
                                    <option value="Matematika">Matematika</option>
                                    <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                    <option value="Bahasa Inggris">Bahasa Inggris</option>
                                    <option value="Fisika">Fisika</option>
                                    <option value="Kimia">Kimia</option>
                                    <option value="Biologi">Biologi</option>
                                    <option value="Sejarah">Sejarah</option>
                                    <option value="Geografi">Geografi</option>
                                    <option value="Ekonomi">Ekonomi</option>
                                    <option value="Sosiologi">Sosiologi</option>
                                    <option value="PKN">PKN</option>
                                    <option value="Agama">Agama</option>
                                    <option value="Seni Budaya">Seni Budaya</option>
                                    <option value="Penjaskes">Penjaskes</option>
                                </select>
                            </div>
                            <div id="homeroomClassDiv" class="hidden">
                                <label for="userClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="userClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Kelas</option>
                                    <option value="10A">10A</option>
                                    <option value="10B">10B</option>
                                    <option value="11A">11A</option>
                                    <option value="11B">11B</option>
                                    <option value="12A">12A</option>
                                    <option value="12B">12B</option>
                                </select>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="closeUserModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Initialize filter statistics
            updateFilterStatistics();
        }

        function showAttendanceReport() {
            document.getElementById('pageTitle').textContent = 'Laporan Absensi';
            document.getElementById('pageSubtitle').textContent = 'Filter, edit, hapus, dan download laporan absensi siswa';
            
            const content = `
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">📊 Laporan Absensi Siswa</h3>
                        <div class="flex gap-3">
                            <button onclick="downloadFilteredExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center gap-2">
                                📥 Download Excel
                            </button>
                            <button onclick="downloadFilteredPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 flex items-center gap-2">
                                📄 Download PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter Section -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <h4 class="text-md font-semibold text-blue-800 mb-4">🔍 Filter Laporan</h4>
                        
                        <!-- Row 1: Basic Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label for="filterStudentName" class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label>
                                <input type="text" id="filterStudentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Cari nama siswa...">
                            </div>
                            <div>
                                <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="filterClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Semua Kelas</option>
                                    <option value="10A">10A</option>
                                    <option value="10B">10B</option>
                                    <option value="11A">11A</option>
                                    <option value="11B">11B</option>
                                    <option value="12A">12A</option>
                                    <option value="12B">12B</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterSubject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select id="filterSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Semua Mata Pelajaran</option>
                                    <option value="Matematika">Matematika</option>
                                    <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                    <option value="Bahasa Inggris">Bahasa Inggris</option>
                                    <option value="Fisika">Fisika</option>
                                    <option value="Kimia">Kimia</option>
                                    <option value="Biologi">Biologi</option>
                                    <option value="Sejarah">Sejarah</option>
                                    <option value="Geografi">Geografi</option>
                                    <option value="Ekonomi">Ekonomi</option>
                                    <option value="Sosiologi">Sosiologi</option>
                                    <option value="PKN">PKN</option>
                                    <option value="Agama">Agama</option>
                                    <option value="Seni Budaya">Seni Budaya</option>
                                    <option value="Penjaskes">Penjaskes</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-2">Status Kehadiran</label>
                                <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Semua Status</option>
                                    <option value="hadir">Hadir</option>
                                    <option value="sakit">Sakit</option>
                                    <option value="izin">Izin</option>
                                    <option value="alpha">Alpha</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Row 2: Date Range and Actions -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label for="filterStartDate" class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                                <input type="date" id="filterStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label for="filterEndDate" class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                                <input type="date" id="filterEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label for="filterNISN" class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                                <input type="text" id="filterNISN" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Cari NISN...">
                            </div>
                            <div class="flex items-end gap-2">
                                <button onclick="applyAttendanceFilters()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200">
                                    🔍 Filter Data
                                </button>
                                <button onclick="resetAttendanceFilters()" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-200">
                                    🔄 Reset
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Filter Buttons -->
                        <div class="flex flex-wrap gap-2">
                            <button onclick="setQuickFilter('today')" class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm hover:bg-green-200 transition duration-200">
                                📅 Hari Ini
                            </button>
                            <button onclick="setQuickFilter('week')" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm hover:bg-blue-200 transition duration-200">
                                📅 Minggu Ini
                            </button>
                            <button onclick="setQuickFilter('month')" class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm hover:bg-purple-200 transition duration-200">
                                📅 Bulan Ini
                            </button>
                            <button onclick="setQuickFilter('alpha')" class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm hover:bg-red-200 transition duration-200">
                                ❌ Hanya Alpha
                            </button>
                            <button onclick="setQuickFilter('absent')" class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm hover:bg-yellow-200 transition duration-200">
                                ⚠️ Tidak Hadir (Sakit/Izin/Alpha)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Statistics Summary -->
                    <div id="filterStats" class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-gray-800" id="totalFilteredRecords">0</p>
                            <p class="text-sm text-gray-600">Total Data</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-green-600" id="filteredHadir">0</p>
                            <p class="text-sm text-green-600">Hadir</p>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-yellow-600" id="filteredSakit">0</p>
                            <p class="text-sm text-yellow-600">Sakit</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-blue-600" id="filteredIzin">0</p>
                            <p class="text-sm text-blue-600">Izin</p>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-red-600" id="filteredAlpha">0</p>
                            <p class="text-sm text-red-600">Alpha</p>
                        </div>
                        <div class="bg-indigo-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-indigo-600" id="filteredPercentage">0%</p>
                            <p class="text-sm text-indigo-600">% Hadir</p>
                        </div>
                    </div>
                    
                    <!-- Results Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Siswa</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="attendanceReportTable">
                                ${generateAttendanceReportTable()}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination (if needed) -->
                    <div id="paginationContainer" class="hidden mt-6 flex justify-between items-center">
                        <div class="text-sm text-gray-700">
                            Menampilkan <span id="showingFrom">1</span> sampai <span id="showingTo">10</span> dari <span id="totalRecords">0</span> data
                        </div>
                        <div class="flex gap-2">
                            <button id="prevPage" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>
                                ← Sebelumnya
                            </button>
                            <button id="nextPage" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>
                                Selanjutnya →
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Initialize filter statistics
            updateFilterStatistics();
        }

        // TEACHER FUNCTIONS
        function showAttendanceHistory() {
            document.getElementById('pageTitle').textContent = 'Riwayat Absensi';
            document.getElementById('pageSubtitle').textContent = 'Lihat riwayat absensi dengan filter pencarian';
            
            const content = `
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label for="historyName" class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label>
                            <input type="text" id="historyName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nama siswa">
                        </div>
                        <div>
                            <label for="historyClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select id="historyClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Semua Kelas</option>
                                <option value="10A">10A</option>
                                <option value="10B">10B</option>
                                <option value="11A">11A</option>
                                <option value="11B">11B</option>
                            </select>
                        </div>
                        <div>
                            <label for="historyNISN" class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                            <input type="text" id="historyNISN" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="NISN">
                        </div>
                        <div class="flex items-end">
                            <button onclick="filterHistory()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                Cari
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="historyStartDate" class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                            <input type="date" id="historyStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="historyEndDate" class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                            <input type="date" id="historyEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div id="historyResults" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Siswa</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="historyTableBody">
                                ${generateHistoryTable()}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Initialize filter statistics
            updateFilterStatistics();
        }

        // PRINCIPAL FUNCTIONS
        function showCompleteReport() {
            document.getElementById('pageTitle').textContent = 'Laporan Lengkap';
            document.getElementById('pageSubtitle').textContent = 'Ringkasan komprehensif kehadiran siswa dan guru';
            
            const todayAttendance = getTodayAttendance();
            const teacherAttendance = getTeacherAttendanceToday();
            const studentsNeedingAttention = getStudentsNeedingAttention();
            
            const content = `
                <!-- Ringkasan Kehadiran Siswa -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 rounded-full">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Siswa Hadir</p>
                                <p class="text-2xl font-semibold text-gray-900">${todayAttendance.present}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-red-100 rounded-full">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Tidak Hadir</p>
                                <p class="text-2xl font-semibold text-gray-900">${todayAttendance.absent}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 rounded-full">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Izin</p>
                                <p class="text-2xl font-semibold text-gray-900">${todayAttendance.izin}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Sakit</p>
                                <p class="text-2xl font-semibold text-gray-900">${todayAttendance.sakit}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ringkasan Kehadiran Guru -->
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Kehadiran Guru Hari Ini</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi Terakhir</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${teacherAttendance.map(teacher => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.subject}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.lastMaterial || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${teacher.status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${teacher.status === 'aktif' ? 'Mengajar' : 'Belum Mengajar'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Siswa Perlu Perhatian -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Siswa Perlu Perhatian Khusus</h3>
                        <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${studentsNeedingAttention.length} siswa</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${studentsNeedingAttention.map(student => `
                            <div class="border border-red-200 bg-red-50 rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="font-medium text-gray-900">${student.name}</p>
                                        <p class="text-sm text-gray-600">Kelas: ${student.class}</p>
                                    </div>
                                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded">${student.alphaCount}x Alpha</span>
                                </div>
                                <div class="text-sm text-gray-600 mb-3">
                                    <p>Kategori: ${getAttentionCategory(student.alphaCount)}</p>
                                    <p>No. WA: ${student.parentPhone}</p>
                                </div>
                                <button onclick="sendWhatsAppNotification('${student.parentPhone}', '${student.name}', ${student.alphaCount})" class="w-full bg-green-600 text-white text-sm py-2 rounded hover:bg-green-700 transition duration-200">
                                    Kirim ke WhatsApp
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Initialize filter statistics
            updateFilterStatistics();
        }

        function showAttendanceMonitoring() {
            document.getElementById('pageTitle').textContent = 'Monitoring Kehadiran';
            document.getElementById('pageSubtitle').textContent = 'Monitor kehadiran siswa dan guru secara real-time';
            
            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Statistik Kehadiran per Kelas -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Statistik Kehadiran per Kelas</h3>
                        <div class="space-y-4">
                            ${getClassAttendanceStats().map(classData => `
                                <div class="border rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="font-medium text-gray-900">Kelas ${classData.class}</h4>
                                        <span class="text-sm text-gray-600">${classData.total} siswa</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2 text-center">
                                        <div class="bg-green-100 rounded p-2">
                                            <p class="text-lg font-semibold text-green-600">${classData.hadir}</p>
                                            <p class="text-xs text-green-600">Hadir</p>
                                        </div>
                                        <div class="bg-yellow-100 rounded p-2">
                                            <p class="text-lg font-semibold text-yellow-600">${classData.sakit}</p>
                                            <p class="text-xs text-yellow-600">Sakit</p>
                                        </div>
                                        <div class="bg-blue-100 rounded p-2">
                                            <p class="text-lg font-semibold text-blue-600">${classData.izin}</p>
                                            <p class="text-xs text-blue-600">Izin</p>
                                        </div>
                                        <div class="bg-red-100 rounded p-2">
                                            <p class="text-lg font-semibold text-red-600">${classData.alpha}</p>
                                            <p class="text-xs text-red-600">Alpha</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Kategori Siswa Bermasalah -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Kategori Siswa Bermasalah</h3>
                        <div class="space-y-3">
                            ${getStudentCategories().map(category => `
                                <div class="flex justify-between items-center p-3 border rounded-lg ${category.color}">
                                    <div>
                                        <p class="font-medium">${category.name}</p>
                                        <p class="text-sm text-gray-600">${category.description}</p>
                                    </div>
                                    <span class="bg-white px-3 py-1 rounded-full text-sm font-medium">${category.count} siswa</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Modal Detail Kategori Siswa -->
                <div id="categoryDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <div>
                                <h3 id="categoryModalTitle" class="text-xl font-bold text-gray-800"></h3>
                                <p id="categoryModalSubtitle" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <button onclick="closeCategoryDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ✕
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <!-- Statistik Kategori -->
                            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-gray-800" id="categoryTotalStudents">0</p>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="categoryTotalHadir">0</p>
                                    <p class="text-sm text-green-600">Total Hadir</p>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-yellow-600" id="categoryTotalSakit">0</p>
                                    <p class="text-sm text-yellow-600">Total Sakit</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="categoryTotalIzin">0</p>
                                    <p class="text-sm text-blue-600">Total Izin</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <p class="text-2xl font-bold text-red-600" id="categoryTotalAlpha">0</p>
                                    <p class="text-sm text-red-600">Total Alpha</p>
                                </div>
                            </div>
                            
                            <!-- Daftar Siswa dalam Kategori -->
                            <div id="categoryStudentList" class="space-y-4">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <!-- Detail Kehadiran Siswa Terpilih -->
                            <div id="studentAttendanceDetail" class="hidden mt-6 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 id="selectedStudentName" class="text-lg font-semibold text-gray-800"></h4>
                                    <button onclick="hideStudentDetail()" class="text-gray-500 hover:text-gray-700">
                                        Tutup Detail
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                            <button onclick="downloadCategoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                📥 Download Excel
                            </button>
                            <button onclick="closeCategoryDetailModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentArea').innerHTML = content;
            
            // Initialize filter statistics
            updateFilterStatistics();
        }

        // Category Detail Modal Functions
        let currentCategoryData = null;
        
        function showCategoryDetail(categoryKey) {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const thirtyDaysAgoString = thirtyDaysAgo.toISOString().split('T')[0];
            
            const classStudents = students.filter(s => s.class === currentUser.class);
            const studentsWithAlpha = classStudents.map(student => {
                const alphaCount = attendanceData.filter(a => 
                    a.studentId === student.id && 
                    a.status === 'alpha' && 
                    a.date >= thirtyDaysAgoString
                ).length;
                return { ...student, alphaCount };
            });
            
            let filteredStudents = [];
            let categoryName = '';
            let categoryDescription = '';
            
            switch(categoryKey) {
                case 'sangat-bermasalah':
                    filteredStudents = studentsWithAlpha.filter(s => s.alphaCount >= 7);
                    categoryName = 'Siswa Sangat Bermasalah';
                    categoryDescription = 'Siswa dengan alpha 7 kali atau lebih dalam 30 hari terakhir';
                    break;
                case 'perlu-perhatian':
                    filteredStudents = studentsWithAlpha.filter(s => s.alphaCount >= 3 && s.alphaCount < 7);
                    categoryName = 'Siswa Perlu Perhatian';
                    categoryDescription = 'Siswa dengan alpha 3-6 kali dalam 30 hari terakhir';
                    break;
                case 'mulai-bermasalah':
                    filteredStudents = studentsWithAlpha.filter(s => s.alphaCount >= 1 && s.alphaCount < 3);
                    categoryName = 'Siswa Mulai Bermasalah';
                    categoryDescription = 'Siswa dengan alpha 1-2 kali dalam 30 hari terakhir';
                    break;
                case 'normal':
                    filteredStudents = studentsWithAlpha.filter(s => s.alphaCount === 0);
                    categoryName = 'Siswa Normal';
                    categoryDescription = 'Siswa tanpa alpha dalam 30 hari terakhir';
                    break;
            }
            
            currentCategoryData = {
                key: categoryKey,
                students: filteredStudents,
                name: categoryName,
                description: categoryDescription
            };
            
            // Update modal title
            document.getElementById('categoryModalTitle').textContent = categoryName;
            document.getElementById('categoryModalSubtitle').textContent = categoryDescription + ` - Kelas ${currentUser.class}`;
            
            // Calculate statistics for this category
            const allAttendanceForCategory = [];
            filteredStudents.forEach(student => {
                const studentAttendance = attendanceData.filter(a => a.studentId === student.id);
                allAttendanceForCategory.push(...studentAttendance);
            });
            
            const stats = {
                totalStudents: filteredStudents.length,
                hadir: allAttendanceForCategory.filter(a => a.status === 'hadir').length,
                sakit: allAttendanceForCategory.filter(a => a.status === 'sakit').length,
                izin: allAttendanceForCategory.filter(a => a.status === 'izin').length,
                alpha: allAttendanceForCategory.filter(a => a.status === 'alpha').length
            };
            
            // Update statistics
            document.getElementById('categoryTotalStudents').textContent = stats.totalStudents;
            document.getElementById('categoryTotalHadir').textContent = stats.hadir;
            document.getElementById('categoryTotalSakit').textContent = stats.sakit;
            document.getElementById('categoryTotalIzin').textContent = stats.izin;
            document.getElementById('categoryTotalAlpha').textContent = stats.alpha;
            
            // Generate student list
            const studentListContainer = document.getElementById('categoryStudentList');
            studentListContainer.innerHTML = filteredStudents.map(student => `
                <div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h5 class="font-medium text-gray-900">${student.name}</h5>
                            <p class="text-sm text-gray-600">NISN: ${student.nisn}</p>
                            <p class="text-sm text-gray-600">No. WA Ortu: ${student.parentPhone}</p>
                        </div>
                        <div class="text-right">
                            <span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded">
                                ${student.alphaCount}x Alpha
                            </span>
                            <p class="text-xs text-gray-500 mt-1">${getAttentionCategory(student.alphaCount)}</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="showStudentAttendanceDetail(${student.id})" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 transition duration-200">
                            📊 Lihat Detail Kehadiran
                        </button>
                        <button onclick="sendQuickWhatsAppNotification('${student.parentPhone}', '${student.name}', ${student.alphaCount}, '${student.class}')" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700 transition duration-200">
                            💬 Kirim WA
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Show modal
            document.getElementById('categoryDetailModal').classList.remove('hidden');
        }
        
        function closeCategoryDetailModal() {
            document.getElementById('categoryDetailModal').classList.add('hidden');
            hideStudentDetail();
        }
        
        function showStudentAttendanceDetail(studentId) {
            const student = students.find(s => s.id === studentId);
            const studentAttendance = attendanceData.filter(a => a.studentId === studentId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Update student name
            document.getElementById('selectedStudentName').textContent = `Detail Kehadiran: ${student.name}`;
            
            // Generate attendance table
            const tableBody = document.getElementById('studentAttendanceTableBody');
            tableBody.innerHTML = studentAttendance.map(attendance => {
                const teacher = users.find(u => u.code === attendance.teacherCode);
                return `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${attendance.date}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${attendance.subject}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 max-w-xs truncate" title="${attendance.material || '-'}">${attendance.material || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(attendance.status)}">
                                ${attendance.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${teacher ? teacher.name : 'Unknown'}</td>
                    </tr>
                `;
            }).join('');
            
            // Show student detail section
            document.getElementById('studentAttendanceDetail').classList.remove('hidden');
        }
        
        function hideStudentDetail() {
            document.getElementById('studentAttendanceDetail').classList.add('hidden');
        }
        
        function downloadCategoryExcel() {
            if (!currentCategoryData) {
                showNotification('Tidak ada data kategori untuk didownload!', 'error');
                return;
            }
            
            // Prepare detailed attendance data for students in this category
            const detailedData = [];
            currentCategoryData.students.forEach(student => {
                const studentAttendance = attendanceData.filter(a => a.studentId === student.id);
                studentAttendance.forEach(attendance => {
                    const teacher = users.find(u => u.code === attendance.teacherCode);
                    detailedData.push({
                        'Kategori': currentCategoryData.name,
                        'Nama Siswa': student.name,
                        'NISN': student.nisn,
                        'Kelas': student.class,
                        'No. WA Ortu': student.parentPhone,
                        'Total Alpha': student.alphaCount,
                        'Tanggal': attendance.date,
                        'Mata Pelajaran': attendance.subject,
                        'Materi': attendance.material || '',
                        'Status': attendance.status.toUpperCase(),
                        'Guru': teacher ? teacher.name : 'Unknown',
                        'Kode Guru': attendance.teacherCode || ''
                    });
                });
            });
            
            // Prepare summary data
            const summaryData = currentCategoryData.students.map(student => {
                const studentAttendance = attendanceData.filter(a => a.studentId === student.id);
                return {
                    'Kategori': currentCategoryData.name,
                    'Nama Siswa': student.name,
                    'NISN': student.nisn,
                    'Kelas': student.class,
                    'No. WA Ortu': student.parentPhone,
                    'Total Alpha': student.alphaCount,
                    'Total Hadir': studentAttendance.filter(a => a.status === 'hadir').length,
                    'Total Sakit': studentAttendance.filter(a => a.status === 'sakit').length,
                    'Total Izin': studentAttendance.filter(a => a.status === 'izin').length,
                    'Total Kehadiran': studentAttendance.length,
                    'Persentase Hadir': studentAttendance.length > 0 ? 
                        Math.round((studentAttendance.filter(a => a.status === 'hadir').length / studentAttendance.length) * 100) + '%' : '0%'
                };
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Add detailed sheet
            const ws1 = XLSX.utils.json_to_sheet(detailedData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Detail Kehadiran');
            
            // Add summary sheet
            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Ringkasan Siswa');
            
            // Download file
            const fileName = `${currentCategoryData.name.replace(/\s+/g, '_')}_Kelas_${currentUser.class}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification(`File Excel "${fileName}" berhasil didownload!`, 'success');
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            currentUser = null;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('publicAccess').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('userCode').value = '';
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'990da61076e34e24',t:'MTc2MDg0OTM2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
